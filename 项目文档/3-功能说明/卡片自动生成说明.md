# å¡ç‰‡è‡ªåŠ¨ç”Ÿæˆè¯´æ˜ (Card Functions)

> å¯¹åº”SQL: `19_card_functions.sql`  
> åˆ›å»ºæ—¶é—´: 2025-11-21

---

## åŠŸèƒ½æ¦‚è¿°

å¡ç‰‡è‡ªåŠ¨ç”Ÿæˆç³»ç»Ÿæ ¹æ®ä½ç½®(Location)ã€æˆ¿é—?Room)ã€åºŠä½?Bed)çš„é…ç½®ï¼Œè‡ªåŠ¨åˆ›å»ºå’Œç»´æŠ¤å‘Šè­¦è·¯ç”±å¡ç‰‡ï¼Œå®ç°æ™ºèƒ½åŒ–çš„å‘Šè­¦åˆ†å‘ã€?
---

## æ ¸å¿ƒæ¦‚å¿µ

### ActiveBed vs NonActiveBed

- **ActiveBed**: æ´»åŠ¨åºŠä½ï¼Œæœ‰ä½æˆ·å…¥ä½ä¸”æœ‰IoTè®¾å¤‡ç›‘æ§
- **NonActiveBed**: éæ´»åŠ¨åºŠä½ï¼Œç©ºåºŠæˆ–æ— è®¾å¤‡ç›‘æ§

### å¡ç‰‡ç±»å‹

1. **ActiveBedå¡ç‰‡**: é’ˆå¯¹å•ä¸ªæ´»åŠ¨åºŠä½çš„ç²¾ç¡®å‘Šè­¦è·¯ç”?2. **Locationå¡ç‰‡**: ä½ç½®çº§åˆ«çš„é€šç”¨å‘Šè­¦è·¯ç”±ï¼ˆå…¬å…±ç©ºé—´ã€å¤šäººæˆ¿é—´ï¼‰

---

## ä¸šåŠ¡é€»è¾‘

### å¡ç‰‡åˆ›å»ºè§„åˆ™

#### åœºæ™¯1ï¼šå•ä¸ªActiveBed
```
æ¡ä»¶: Locationæœ‰ä¸”ä»…æœ‰1ä¸ªActiveBed
â†?åˆ›å»º: 1ä¸ªActiveBedå¡ç‰‡
å¡ç‰‡åç§°: {resident_name} æˆ?{location_name}
å¡ç‰‡åœ°å€: {location_name} - {bed_name}
```

#### åœºæ™¯2ï¼šå¤šä¸ªActiveBed
```
æ¡ä»¶: Locationæœ‰å¤šä¸ªActiveBed
â†?åˆ›å»º: Nä¸ªActiveBedå¡ç‰‡ + 1ä¸ªLocationå¡ç‰‡
ActiveBedå¡ç‰‡: æ¯ä¸ªåºŠä½ä¸€ä¸?Locationå¡ç‰‡: ä½ç½®é€šç”¨å¡ç‰‡
```

#### åœºæ™¯3ï¼šæ— ActiveBed
```
æ¡ä»¶: Locationæ²¡æœ‰ActiveBed
â†?åˆ›å»º: 1ä¸ªLocationå¡ç‰‡
ç”¨é€? å…¬å…±ç©ºé—´å‘Šè­¦è·¯ç”±
```

---

## å¡ç‰‡å‘½åè§„åˆ™

### ActiveBedå¡ç‰‡åç§°ä¼˜å…ˆçº?1. ä½æˆ·å§“å (resident.last_name + first_name)
2. ä½ç½®åç§° (location.location_name)
3. åºŠä½åç§° (bed.bed_name)

**ç¤ºä¾‹**ï¼?```
åœºæ™¯: Location "Room 201", Bed "A", Resident "å¼ ä¸‰"
â†?å¡ç‰‡åç§°: "å¼ ä¸‰"
â†?å¡ç‰‡åœ°å€: "Room 201 - A"
```

### Locationå¡ç‰‡åç§°
- ç›´æ¥ä½¿ç”¨ location.location_name
- ç¤ºä¾‹: "å¤§å…"ã€?èµ°å»Š"ã€?Room 201"

---

## æ•°æ®æ¨¡å‹

### Card Fields

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| card_id | UUID | å¡ç‰‡ID |
| tenant_id | UUID | ç§Ÿæˆ·ID |
| card_type | string | å¡ç‰‡ç±»å‹ï¼ˆActiveBed/Locationï¼‰|
| bed_id | UUID | åºŠä½IDï¼ˆActiveBedå¡ç‰‡ï¼‰|
| location_id | UUID | ä½ç½®ID |
| card_name | string | å¡ç‰‡åç§° |
| card_address | string | å¡ç‰‡åœ°å€ |
| resident_id | UUID | ä½æˆ·IDï¼ˆActiveBedå¡ç‰‡ï¼‰|
| is_public_space | boolean | æ˜¯å¦å…¬å…±ç©ºé—´ |
| routing_alert_user_ids | UUID[] | å‘Šè­¦æ¥æ”¶è€…IDåˆ—è¡¨ |
| is_active | boolean | æ˜¯å¦æ¿€æ´?|

---

## APIç«¯ç‚¹

### 1. ä¸ºæŒ‡å®šLocationé‡æ–°ç”Ÿæˆå¡ç‰‡
```
POST /api/v1/card_functions/regenerate_location
```

**è¯·æ±‚ä½?*ï¼?```json
{
  "location_id": "uuid",
  "tenant_id": "uuid"
}
```

**åŠŸèƒ½**ï¼?- åˆ é™¤è¯¥Locationçš„æ‰€æœ‰ç°æœ‰å¡ç‰?- é‡æ–°è®¡ç®—ActiveBed
- æŒ‰è§„åˆ™ç”Ÿæˆæ–°å¡ç‰‡
- è¿”å›ç”Ÿæˆçš„å¡ç‰‡åˆ—è¡?
### 2. æ‰¹é‡é‡æ–°ç”Ÿæˆæ‰€æœ‰å¡ç‰?```
POST /api/v1/card_functions/regenerate_all
```

**è¯·æ±‚ä½?*ï¼?```json
{
  "tenant_id": "uuid"
}
```

**åŠŸèƒ½**ï¼?- åˆ é™¤ç§Ÿæˆ·æ‰€æœ‰å¡ç‰?- éå†æ‰€æœ‰Location
- æ‰¹é‡é‡æ–°ç”Ÿæˆå¡ç‰‡

### 3. é¢„è§ˆå¡ç‰‡ç”Ÿæˆç»“æœ
```
POST /api/v1/card_functions/preview
```

**è¯·æ±‚ä½?*ï¼?```json
{
  "location_id": "uuid",
  "tenant_id": "uuid"
}
```

**åŠŸèƒ½**ï¼?- ä¸å®é™…åˆ›å»ºå¡ç‰?- è¿”å›å°†è¦ç”Ÿæˆçš„å¡ç‰‡ä¿¡æ?- ç”¨äºéªŒè¯ç”Ÿæˆé€»è¾‘

---

## æ ¸å¿ƒæœåŠ¡

### CardService (card_service.py)

#### 1. calculate_card_address()
è®¡ç®—å¡ç‰‡åœ°å€

```python
def calculate_card_address(location, bed):
    """
    è¿”å›: "{location_name} - {bed_name}"
    ç¤ºä¾‹: "Room 201 - A"
    """
```

#### 2. is_active_bed()
åˆ¤æ–­æ˜¯å¦ä¸ºActiveBed

```python
def is_active_bed(bed, residents, devices):
    """
    æ¡ä»¶:
    1. bed_type == "ActiveBed"
    2. resident_id ä¸ä¸ºç©?    3. æœ‰ç»‘å®šçš„è®¾å¤‡ä¸”è®¾å¤‡åœ¨çº?    """
```

#### 3. generate_cards_for_location()
ä¸ºLocationç”Ÿæˆå¡ç‰‡

```python
def generate_cards_for_location(location_id, tenant_id):
    """
    ä¸»é€»è¾‘:
    1. æŸ¥è¯¢Locationã€Roomsã€Beds
    2. è¯†åˆ«ActiveBeds
    3. æŒ‰è§„åˆ™åˆ›å»ºå¡ç‰?    4. è¿”å›å¡ç‰‡åˆ—è¡¨
    """
```

---

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šä½æˆ·å…¥ä½?```
æ“ä½œ: åˆ†é…resident_idåˆ°bed, è®¾å¤‡ä¸Šçº¿
è§¦å‘: generate_cards_for_location()
ç»“æœ: åˆ›å»ºActiveBedå¡ç‰‡
```

### åœºæ™¯2ï¼šä½æˆ·å‡ºé™?```
æ“ä½œ: æ¸…ç©ºbed.resident_id
è§¦å‘: regenerate_location()
ç»“æœ: åˆ é™¤ActiveBedå¡ç‰‡ï¼Œå¯èƒ½åˆ›å»ºLocationå¡ç‰‡
```

### åœºæ™¯3ï¼šè®¾å¤‡æ•…éš?```
æ“ä½œ: è®¾å¤‡çŠ¶æ€å˜ä¸ºoffline
è§¦å‘: is_active_bed() è¿”å›False
ç»“æœ: é‡æ–°ç”Ÿæˆä¸ºLocationå¡ç‰‡
```

### åœºæ™¯4ï¼šæ‰¹é‡åˆå§‹åŒ–
```
æ“ä½œ: ç³»ç»Ÿåˆæ¬¡éƒ¨ç½²
è§¦å‘: regenerate_all()
ç»“æœ: ä¸ºæ‰€æœ‰Locationç”Ÿæˆå¡ç‰‡
```

---

## å‘Šè­¦è·¯ç”±å…³ç³»

```
å‘Šè­¦å‘ç”Ÿ â†?æŸ¥æ‰¾è®¾å¤‡ â†?è·å–bed_id â†?æŸ¥æ‰¾å¡ç‰‡
                                      â†?                    ActiveBedå¡ç‰‡ â†?ç²¾ç¡®è·¯ç”±åˆ°ä½æˆ·æŠ¤ç†å›¢é˜?                    Locationå¡ç‰‡ â†?è·¯ç”±åˆ°åŒºåŸŸè´Ÿè´£äºº
```

### è·¯ç”±ä¼˜å…ˆçº?1. ä¼˜å…ˆä½¿ç”¨ActiveBedå¡ç‰‡ï¼ˆç²¾ç¡®ï¼‰
2. é™çº§ä½¿ç”¨Locationå¡ç‰‡ï¼ˆé€šç”¨ï¼?3. æœ€åä½¿ç”¨ç§Ÿæˆ·é»˜è®¤æ¥æ”¶è€?
---

## è‡ªåŠ¨è§¦å‘æœºåˆ¶

### éœ€è¦é‡æ–°ç”Ÿæˆå¡ç‰‡çš„æƒ…å†µ

1. **Residentå˜æ›´**
   - å…¥ä½/å‡ºé™¢
   - æ›´æ¢åºŠä½
   - çŠ¶æ€å˜æ›?
2. **Bedå˜æ›´**
   - bed_typeå˜æ›´
   - resident_idå˜æ›´
   - è®¾å¤‡ç»‘å®šå˜æ›´

3. **Deviceå˜æ›´**
   - è®¾å¤‡ä¸Šçº¿/ä¸‹çº¿
   - è®¾å¤‡ç»‘å®šå˜æ›´

4. **Locationå˜æ›´**
   - é…ç½®å˜æ›´
   - Room/Bedå¢åˆ 

---

## å®ç°çŠ¶æ€?
- âœ?åç«¯Service (card_service.py) - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- âœ?åç«¯API (card_functions.py) - 3ä¸ªç«¯ç‚?- â?ç¤ºä¾‹æ•°æ®ï¼ˆé€šè¿‡APIåŠ¨æ€ç”Ÿæˆï¼‰
- âœ?å‰ç«¯ç±»å‹ (Cardå·²æœ‰)
- â?å‰ç«¯é¡µé¢ï¼ˆå¾…å¼€å‘ï¼‰
- âœ?æ–‡æ¡£

**å®Œæˆåº?*: 67%

---

## æµ‹è¯•ç¤ºä¾‹

### Pythonæµ‹è¯•
```python
from app.services.card_service import CardService

service = CardService()

# ä¸ºLocationç”Ÿæˆå¡ç‰‡
cards = service.generate_cards_for_location(
    location_id="xxx",
    tenant_id="yyy"
)

print(f"ç”Ÿæˆäº?{len(cards)} ä¸ªå¡ç‰?)
for card in cards:
    print(f"{card['card_type']}: {card['card_name']}")
```

---

## æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½è€ƒè™‘**
   - å¤§é‡Locationæ—¶é¿å…é¢‘ç¹regenerate_all
   - ä½¿ç”¨previewéªŒè¯åå†æ‰§è¡Œ
   - è€ƒè™‘å¼‚æ­¥å¤„ç†

2. **æ•°æ®ä¸€è‡´æ€?*
   - åˆ é™¤Residentæ—¶æ¸…ç†å¡ç‰?   - åˆ é™¤Deviceæ—¶æ›´æ–°å¡ç‰?   - äº‹åŠ¡æ€§æ“ä½?
3. **å‘Šè­¦è·¯ç”±**
   - ç¡®ä¿æ¯ä¸ªLocationè‡³å°‘æœ?ä¸ªå¡ç‰?   - éªŒè¯routing_alert_user_idsæœ‰æ•ˆ
   - å¤„ç†ç©ºæ¥æ”¶è€…æƒ…å†?
---

## å‚è€ƒæ–‡æ¡?
- `20_Card_Creation_Rules_Final.md` - è¯¦ç»†åˆ›å»ºè§„åˆ™
- `23_Card_Functions_Usage.md` - ä½¿ç”¨æŒ‡å—
- `25_Alarm_Notification_Flow.md` - å‘Šè­¦æµç¨‹

---

**æœ€åæ›´æ–?*: 2025-11-21

# 项目状态自动更新说明

## 📋 概述

为了避免`项目状态.json`过时，已设置自动更新机制。

---

## 🔄 自动更新方式

### 方式1: Git提交时自动更新 (推荐) ✅

**工作原理**: 
- 每次执行`git commit`时，Git Hook会自动运行更新脚本
- 更新后的状态文件会自动添加到本次提交中
- 完全自动，无需手动操作

**已配置**: 
- `.git/hooks/pre-commit` - Git Hook脚本

**无需任何操作，每次提交会自动更新！**

---

### 方式2: 手动运行更新脚本

#### Windows用户
双击运行：
```
update_status.bat
```

#### 命令行
```bash
python update_project_status.py
```

---

## 📊 更新内容

自动更新脚本会扫描并更新以下内容：

### 代码统计
- ✅ **后端代码行数** - 扫描`backend/app/*.py`
- ✅ **前端代码行数** - 扫描`frontend/src/*.tsx, *.ts`
- ✅ **文档行数** - 扫描`项目记录/*.md`
- ✅ **文件数量** - Python文件、TypeScript文件

### Git统计
- ✅ **Git提交总数** - 自动统计

### 运行状态
- ✅ **后端服务器状态** - 检测端口8000
- ✅ **前端服务器状态** - 检测端口3000
- ✅ **检查时间戳**

### 元数据
- ✅ **最后更新时间** - 自动更新为当前时间

---

## 🛠️ 技术实现

### 更新脚本 (`update_project_status.py`)

```python
功能：
1. 扫描项目文件统计代码行数
2. 统计Git提交次数
3. 检测服务运行状态
4. 更新项目状态.json
```

**智能排除**:
- ❌ `node_modules/` - npm依赖
- ❌ `__pycache__/` - Python缓存
- ❌ `.venv/` - Python虚拟环境
- ❌ `dist/` - 构建输出

### Git Hook (`pre-commit`)

```bash
工作流程：
1. 用户执行 git commit
2. Hook自动运行更新脚本
3. 更新 项目状态.json
4. 将更新后的文件添加到提交
5. 继续正常提交流程
```

---

## 📝 更新示例

运行更新脚本后的输出：

```
🔍 扫描项目文件...
✅ 项目状态已更新！

📊 统计结果:
   后端代码: 8,234 行 (45 个Python文件)
   前端代码: 2,301 行 (23 个TypeScript文件)
   文档: 3,012 行
   总计: 13,547 行
   Git提交: 22 次

🖥️  服务状态:
   后端服务器: 🟢 运行中
   前端服务器: 🟢 运行中

📝 状态文件: d:\test_Project\owlRD-原型项目\项目记录\项目状态.json
```

---

## 🎯 使用建议

### 开发过程中
- ✅ **不需要手动更新** - Git提交时自动更新
- ✅ **想立即查看统计** - 运行`update_status.bat`

### 重要节点
- ✅ **完成新功能后** - 提交代码，状态自动更新
- ✅ **准备汇报时** - 手动运行获取最新数据
- ✅ **项目检查时** - 手动运行确认状态

### 特殊情况
- ⚠️ **如果Hook未生效** - 手动运行`update_status.bat`
- ⚠️ **需要禁用自动更新** - 删除`.git/hooks/pre-commit`

---

## 🔧 故障排查

### 问题1: Git Hook不工作

**解决方案**:
```bash
# 确保Hook有执行权限 (Linux/Mac)
chmod +x .git/hooks/pre-commit

# 或手动运行
python update_project_status.py
git add 项目记录/项目状态.json
```

### 问题2: 统计数据不准确

**可能原因**:
- 新增文件扩展名未包含在扫描中
- 某些目录被错误排除

**解决方案**:
- 修改`update_project_status.py`中的扩展名列表
- 检查目录排除规则

### 问题3: 服务状态检测失败

**可能原因**:
- PowerShell不可用
- 端口检测超时

**解决方案**:
- 脚本会优雅处理错误，不影响更新
- 服务状态仅供参考

---

## 📋 维护

### 添加新的统计项

编辑`update_project_status.py`，在`update_project_status()`函数中添加：

```python
# 示例：添加测试文件统计
test_files = count_files(backend_dir / "tests", "*.py")
status['code_statistics']['test_files'] = test_files
```

### 修改扫描目录

在`count_code_lines()`函数中修改排除规则：

```python
if 'your_exclude_dir' in str(file_path):
    continue
```

---

## ✅ 验证

### 检查自动更新是否工作

1. 修改任意代码文件
2. 执行`git add .`
3. 执行`git commit -m "test"`
4. 观察是否输出"🔄 自动更新项目状态..."
5. 检查`项目状态.json`的`last_updated`时间戳

### 手动测试

```bash
python update_project_status.py
```

应该看到统计输出和"✅ 项目状态已更新！"

---

## 🎉 总结

✅ **已配置自动更新机制**  
✅ **Git提交时自动运行**  
✅ **也可手动运行**  
✅ **智能统计代码和状态**  
✅ **不会再过时！**

---

**创建时间**: 2025-11-20  
**版本**: 1.0  
**维护**: 自动更新脚本

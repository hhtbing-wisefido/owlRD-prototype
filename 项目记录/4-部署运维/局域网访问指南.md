# owlRD 局域网访问完整指南

**局域网IP**: `192.168.2.6`  
**最后更新**: 2025-11-21  
**文档状态**: ✅ 已验证配置正确

---

## 📋 快速开始

### 1. 启动后端（已自动配置局域网访问）

```bash
cd backend

# 首次运行：下载Swagger UI静态文件
python download_swagger_ui.py

# 启动服务（已配置host=0.0.0.0）
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# 或使用启动脚本
start_lan.bat    # Windows
./start_lan.sh   # Linux/Mac
```

**访问地址**:
- 本机: http://localhost:8000 或 http://192.168.2.6:8000
- 局域网设备: http://192.168.2.6:8000

**API文档**:
- 本地Swagger UI: http://192.168.2.6:8000/docs-local
- 国内CDN版本: http://192.168.2.6:8000/docs-cn
- 离线版本: http://192.168.2.6:8000/docs-offline

---

### 2. 启动前端（已配置局域网访问）

```bash
cd frontend

# 安装依赖（首次）
npm install

# 方法1: 使用npm脚本（推荐）
npm run dev

# 方法2: 使用启动脚本
start_lan.bat    # Windows
./start_lan.sh   # Linux/Mac

# 方法3: 指定IP启动
npm run dev:lan
```

**访问地址**:
- 本机: http://localhost:3000 或 http://192.168.2.6:3000
- 局域网设备: http://192.168.2.6:3000

---

## 🔧 配置详解

### 后端配置

#### 1. CORS配置 (`backend/app/config.py`)

已添加局域网IP到CORS白名单:

```python
cors_origins: List[str] = Field(
    default=[
        "http://localhost:3000",
        "http://127.0.0.1:3000",
        "http://localhost:8000",
        "http://127.0.0.1:8000",
        "http://192.168.2.6:3000",  # 局域网前端
        "http://192.168.2.6:8000",  # 局域网后端
        "*"  # 开发环境允许所有源
    ],
    env="CORS_ORIGINS"
)
```

#### 2. 服务器绑定

后端已配置为 `host=0.0.0.0`，自动监听所有网络接口，包括:
- localhost (127.0.0.1)
- 局域网IP (192.168.2.6)
- 其他网络接口

---

### 前端配置

#### 1. Vite配置 (`package.json`)

已添加 `--host` 参数:

```json
{
  "scripts": {
    "dev": "vite --host",
    "dev:lan": "vite --host 192.168.2.6",
    "preview": "vite preview --host"
  }
}
```

#### 2. 环境变量配置

**本地开发** (`.env`):
```bash
VITE_API_URL=http://localhost:8000
VITE_WS_URL=ws://localhost:8000
```

**局域网访问** (`.env`):
```bash
VITE_API_URL=http://192.168.2.6:8000
VITE_WS_URL=ws://192.168.2.6:8000
```

**注意**: 修改 `.env` 后需要重启开发服务器

---

## 🌐 访问测试

### 本机测试

#### 后端测试
```bash
# 测试本地访问
curl http://localhost:8000/health

# 测试局域网IP访问
curl http://192.168.2.6:8000/health
```

预期响应:
```json
{"status":"healthy","timestamp":"2025-11-20T..."}
```

#### 前端测试
浏览器访问:
- http://localhost:3000
- http://192.168.2.6:3000

应该都能正常显示Dashboard页面。

---

### 局域网其他设备测试

#### 准备工作
1. 确保设备连接到同一局域网
2. 确保防火墙允许端口 3000 和 8000

#### 测试步骤

**1. 测试后端连接**

在局域网设备浏览器访问:
```
http://192.168.2.6:8000/health
```

应该返回 JSON 健康检查数据。

**2. 测试API文档**

访问 Swagger UI:
```
http://192.168.2.6:8000/docs-local
```

应该能正常显示API文档界面。

**3. 测试前端应用**

访问前端应用:
```
http://192.168.2.6:3000
```

应该能正常显示仪表板。

**4. 测试WebSocket连接**

在前端页面右上角查看连接状态:
- 绿色 "实时连接" = WebSocket正常
- 灰色 "连接断开" = WebSocket未连接

---

## 🛡️ 防火墙配置

### Windows防火墙

#### 方法1: 使用PowerShell（管理员权限）

```powershell
# 允许端口 8000（后端）
New-NetFirewallRule -DisplayName "owlRD Backend" -Direction Inbound -LocalPort 8000 -Protocol TCP -Action Allow

# 允许端口 3000（前端）
New-NetFirewallRule -DisplayName "owlRD Frontend" -Direction Inbound -LocalPort 3000 -Protocol TCP -Action Allow
```

#### 方法2: 使用图形界面

1. 打开 "Windows Defender 防火墙"
2. 点击 "高级设置"
3. 选择 "入站规则" → "新建规则"
4. 选择 "端口" → "下一步"
5. 选择 "TCP"，输入端口 `8000` → "下一步"
6. 选择 "允许连接" → "下一步"
7. 全部勾选（域、专用、公用） → "下一步"
8. 输入名称 "owlRD Backend" → "完成"
9. 重复步骤为端口 `3000` 创建规则

#### 验证防火墙规则

```powershell
Get-NetFirewallRule | Where-Object {$_.DisplayName -like "*owlRD*"}
```

---

### Linux防火墙 (UFW)

```bash
# 允许端口 8000
sudo ufw allow 8000/tcp

# 允许端口 3000
sudo ufw allow 3000/tcp

# 查看规则
sudo ufw status
```

---

### macOS防火墙

macOS默认防火墙通常允许所有出站连接和应用程序连接。如需配置:

1. 系统偏好设置 → 安全性与隐私 → 防火墙
2. 点击 "防火墙选项"
3. 添加 Node.js 和 Python 应用程序
4. 设置为 "允许传入连接"

---

## 🔍 故障排查

### 问题1: 局域网设备无法访问后端

**症状**: 访问 `http://192.168.2.6:8000` 超时或拒绝连接

**解决方案**:

1. **检查后端是否运行**
   ```bash
   # 本机测试
   curl http://localhost:8000/health
   ```

2. **检查防火墙**
   - Windows: 确认端口 8000 已添加到防火墙规则
   - Linux: `sudo ufw status`
   - 临时禁用防火墙测试: `sudo ufw disable`

3. **检查IP地址**
   ```bash
   # Windows
   ipconfig
   
   # Linux/Mac
   ifconfig
   ip addr
   ```
   确认 IP 是 `192.168.2.6`

4. **检查CORS配置**
   查看 `backend/app/config.py` 中的 `cors_origins`

---

### 问题2: 前端无法访问

**症状**: 访问 `http://192.168.2.6:3000` 无法连接

**解决方案**:

1. **确认启动时使用了 `--host` 参数**
   ```bash
   npm run dev
   ```
   查看输出应该有:
   ```
   ➜  Local:   http://localhost:3000/
   ➜  Network: http://192.168.2.6:3000/
   ```

2. **检查防火墙端口 3000**

3. **重启开发服务器**
   ```bash
   # Ctrl+C 停止
   npm run dev
   ```

---

### 问题3: 前端能访问但无法连接后端API

**症状**: 前端页面能打开，但没有数据显示

**解决方案**:

1. **检查 `.env` 配置**
   ```bash
   VITE_API_URL=http://192.168.2.6:8000
   VITE_WS_URL=ws://192.168.2.6:8000
   ```

2. **重启前端服务器**（修改 `.env` 后必须重启）

3. **浏览器控制台检查错误**
   - F12 打开开发者工具
   - 查看 Console 和 Network 标签
   - 检查是否有 CORS 错误

---

### 问题4: WebSocket连接失败

**症状**: 前端显示 "连接断开"

**解决方案**:

1. **检查后端WebSocket端点**
   ```bash
   # 浏览器访问
   http://192.168.2.6:8000/api/v1/realtime/ws/10000000-0000-0000-0000-000000000001
   ```

2. **检查 `.env` 中的 WebSocket URL**
   ```bash
   VITE_WS_URL=ws://192.168.2.6:8000
   ```

3. **检查防火墙是否阻止WebSocket连接**

---

## 📱 移动设备访问

### iOS设备

1. 确保iPhone/iPad连接到同一WiFi
2. Safari浏览器访问: `http://192.168.2.6:3000`
3. 可添加到主屏幕以获得类似App的体验

### Android设备

1. 确保设备连接到同一WiFi
2. Chrome浏览器访问: `http://192.168.2.6:3000`
3. 可通过菜单 "添加到主屏幕"

---

## 🔐 安全注意事项

### 开发环境（当前配置）

- ✅ 允许所有CORS源 (`*`)
- ✅ 无需认证
- ✅ 绑定所有网络接口 (`0.0.0.0`)

**适用于**: 开发和测试环境

### 生产环境（建议配置）

1. **限制CORS源**
   ```python
   cors_origins: List[str] = Field(
       default=[
           "https://your-domain.com",
           "https://app.your-domain.com"
       ]
   )
   ```

2. **添加认证**
   - JWT Token
   - OAuth 2.0
   - API Key

3. **使用HTTPS**
   - 配置SSL证书
   - 强制HTTPS重定向

4. **限制绑定IP**
   ```python
   host: str = Field(default="192.168.2.6")  # 仅绑定特定IP
   ```

5. **配置防火墙规则**
   - 仅允许特定IP范围
   - 限制访问端口

---

## 📊 性能优化

### 局域网优化建议

1. **使用本地Swagger UI** (避免CDN)
   ```
   http://192.168.2.6:8000/docs-local
   ```

2. **减少WebSocket重连间隔**
   修改 `frontend/src/hooks/useWebSocket.ts`:
   ```typescript
   reconnectInterval = 1000  // 从3000改为1000ms
   ```

3. **启用HTTP/2**（生产环境）

4. **配置缓存策略**

---

## 🎯 最佳实践

### 开发流程

1. **本地开发**
   - 使用 `localhost` 进行快速开发
   - 代码变更实时热更新

2. **局域网测试**
   - 定期在局域网设备测试
   - 验证响应式布局
   - 测试WebSocket连接

3. **多设备测试**
   - 在不同设备测试UI
   - 验证触摸交互
   - 测试不同屏幕尺寸

---

## 📝 常用命令汇总

### 后端

```bash
# 启动（局域网访问）
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# 健康检查
curl http://192.168.2.6:8000/health

# 查看日志
tail -f logs/app.log
```

### 前端

```bash
# 启动（局域网访问）
npm run dev

# 构建
npm run build

# 预览构建结果
npm run preview
```

### 防火墙

```powershell
# Windows: 查看规则
Get-NetFirewallRule | Where-Object {$_.DisplayName -like "*owlRD*"}

# Windows: 删除规则
Remove-NetFirewallRule -DisplayName "owlRD Backend"
Remove-NetFirewallRule -DisplayName "owlRD Frontend"
```

---

## 🔗 相关文档

- [后端README](backend/README.md)
- [前端README](frontend/README.md)
- [前端开发总结](frontend/DEVELOPMENT_SUMMARY.md)
- [项目总README](README.md)

---

**最后更新**: 2025-11-20 18:45  
**局域网IP**: 192.168.2.6  
**后端端口**: 8000  
**前端端口**: 3000  
**状态**: ✅ 已配置完成，可立即使用

# Alert告警系统完整对齐修正报告

**修正时间**: 2025-11-22 17:00  
**问题类型**: 源参考对齐不一致  
**修正范围**: 后端+前端+文档全面对齐

---

## 问题发现过程

### 触发事件
运行`init_sample_data.py`创建alert数据时失败：
```
❌ Error: severity: 告警级别无效; alert_time: 告警时间不能为空
```

### 深入分析
1. **validation.py**要求：
   - `severity`: ["low", "medium", "high", "critical"]
   - `alert_time`: 必需

2. **models/alert.py**定义：
   - `alert_level`: "L1/L2/L3/L5/L8/L9/DISABLE"
   - `timestamp`: datetime

3. **init_sample_data.py**使用：
   - `severity`: "L1/L2"
   - 缺少`alert_time`

**结论：三者完全不一致！**

---

## 源参考确认

### 1. TDPv2-0916.md（协议定义）
```protobuf
enum DangerLevel {
  EMERGENCY = 1;  // L1 - 紧急
  ALERT = 2;      // L2 - 警报
  CRITICAL = 3;   // L3 - 严重
  WARNING = 5;    // L5 - 警告
  DEBUG = 8;      // L8 - 调试
  Cancle = 9;     // L9 - 取消
}
```

字段：
- `danger_level`: DangerLevel枚举
- `alert_timestamp`: 告警时间

### 2. 25_Alarm_Notification_Flow.md（告警流程）

告警级别：
- **L1** (EMERGENCY): 紧急，高风险高置信
- **L2** (ALERT): 警报，高危事件
- **L3** (CRITICAL): 严重
- **L5** (WARNING): 警告
- **L8** (DEBUG): 调试
- **L9** (CANCEL): 取消
- **DISABLE**: 关闭

推荐使用：**['DISABLE','L1','L2']**

告警路由机制：
- ActiveBed卡片 → resident_caregivers查找护士
- Location卡片（公共空间）→ alert_user_ids + alert_tags
- 用户过滤：alert_levels, alert_scope, alert_channels

### 3. 13_iot_monitor_alerts.sql & 14_cloud_alert_policies.sql
- 13: IoT设备报警**配置**表
- 14: 云端报警**策略**表
- ❌ **没有告警记录表定义**

**Alert模型是协议扩展实现！**

---

## 修正内容

### ✅ 后端文件（10个）

#### 1. models/alert.py
```python
"""
对齐源参考：
1. TDPv2-0916.md - 协议定义（DangerLevel枚举）
2. 25_Alarm_Notification_Flow.md - 告警流程
3. 14_cloud_alert_policies.sql - 云端策略表

注意：
- Alert模型是协议扩展实现，源SQL中没有对应表
- 告警级别使用 L1/L2/L3/L5/L8/L9/DISABLE
- 时间字段使用 timestamp
- 状态字段使用 pending/acknowledged/resolved/dismissed
"""
```

#### 2. utils/validation.py
修正告警验证器：
```python
# 使用alert_level而非severity（对齐源参考）
validator.add_rule("alert_level", required, "告警级别不能为空")
validator.add_rule("alert_level", in_choices([
    "L1", "L2", "L3", "L5", "L8", "L9", "DISABLE"
]), "告警级别无效")

# 使用timestamp而非alert_time（对齐models）
validator.add_rule("timestamp", required, "告警时间不能为空")

# status包含dismissed而非ignored
validator.add_rule("status", in_choices([
    "pending", "acknowledged", "resolved", "dismissed"
]), "状态值无效")
```

#### 3. scripts/init_sample_data.py
修正alert创建数据：
```python
alerts = [
    {
        "alert_id": str(uuid4()),
        "tenant_id": SAMPLE_TENANT_ID,
        "alert_type": "HEART_RATE_HIGH",
        "alert_level": "L1",  # L1=EMERGENCY（对齐TDPv2）
        "status": "pending",
        "timestamp": (datetime.now() - timedelta(hours=2)).isoformat(),
        "message": "心率异常：120 bpm",  # 对齐models/alert.py
        "resident_id": SAMPLE_RESIDENT_ID,
        "device_id": SAMPLE_DEVICE_ID,
        "location_id": SAMPLE_LOCATION_ID,
        # 升级/抑制机制（对齐25_Alarm_Notification_Flow.md）
        "escalation_level": 0,
        "escalated_at": None,
        "suppressed_until": None,
        "auto_escalate": True
    }
]
```

#### 4. api/v1/alerts.py
添加源参考说明：
```python
"""
对齐源参考：
- TDPv2-0916.md - 告警协议定义
- 25_Alarm_Notification_Flow.md - 告警路由和处理流程
- models/alert.py - Alert数据模型

字段说明：
- alert_level: L1/L2/L3/L5/L8/L9/DISABLE
- status: pending/acknowledged/resolved/dismissed
- timestamp: 告警发生时间
"""
```

#### 5. api/v1/alert_policies.py
添加源参考说明：
```python
"""
对齐源参考：
- 14_cloud_alert_policies.sql - 云端告警策略表定义
- TDPv2-0916.md - DangerLevel定义（L1/L2/DISABLE）
- 25_Alarm_Notification_Flow.md - 告警策略配置说明
"""
```

#### 6. services/alert_engine.py
添加详细说明：
```python
"""
对齐源参考：
- 25_Alarm_Notification_Flow.md - 完整告警流程定义
  * 告警路由机制（ActiveBed/Location卡片路由）
  * 告警级别确定规则：max(云端级别, IoT级别)
  * 用户过滤（alert_levels, alert_scope, alert_channels）
  * 升级、抑制、静默机制
- TDPv2-0916.md - DangerLevel协议定义
- 14_cloud_alert_policies.sql - 云端策略表
"""
```

#### 7. models/user.py
添加alert配置说明：
```python
"""
对齐源参考：
- 03_users.sql - 用户表定义  
- 25_Alarm_Notification_Flow.md - 用户告警配置说明
  * alert_levels: 接收的告警级别（L1/L2/L3等）
  * alert_channels: 接收通道（APP/EMAIL等）
  * alert_scope: 接收范围（ALL/LOCATION-TAG/ASSIGNED_ONLY）
"""
```

#### 8. models/location.py
添加路由说明：
```python
"""
对齐源参考：
- 25_Alarm_Notification_Flow.md - Location卡片告警路由规则
  * alert_user_ids: 直接指定的告警接收者
  * alert_tags: 标签匹配的告警接收者（如NightShift, TeamA）
  * 用于公共空间/多人房间的告警路由
"""
```

#### 9. models/card.py
添加路由说明：
```python
"""
对齐源参考：
- 25_Alarm_Notification_Flow.md - 卡片告警路由规则
  * routing_alert_user_ids: 覆盖location的告警接收者
  * routing_alert_tags: 覆盖location的告警标签
  * 如果设置，则优先使用卡片配置而非location配置
"""
```

#### 10. services/care_quality.py
添加评分说明：
```python
"""
对齐源参考：
- 17_care_quality_reports.sql - 护理质量报告表
- AI护理.md - AI分析方法和指标
- 评分维度包含告警响应速度和告警处理质量
"""
```

---

### ✅ 前端文件（3个）

#### 1. frontend/src/types/index.ts
```typescript
// Alert types
// 对齐源参考：TDPv2-0916.md, 25_Alarm_Notification_Flow.md, models/alert.py
export interface Alert {
  alert_id: string
  tenant_id: string
  alert_level: string  // L1/L2/L3/L5/L8/L9/DISABLE（对齐TDPv2协议）
  alert_type: string   // FALL/HEART_RATE_HIGH/RESPIRATORY_RATE_HIGH等
  message: string
  timestamp: string    // 告警发生时间（对齐协议alert_timestamp）
  status: string       // pending/acknowledged/resolved/dismissed
  // ... 其他字段
  // 告警升级/抑制机制（对齐25_Alarm_Notification_Flow.md）
  escalation_level?: number
  escalated_at?: string
  suppressed_until?: string
  auto_escalate?: boolean
}
```

#### 2. frontend/src/pages/Alerts.tsx
添加注释：
```typescript
/**
 * 告警管理页面
 * 
 * 对齐源参考：
 * - TDPv2-0916.md - 告警协议（alert_level: L1/L2/L3等）
 * - 25_Alarm_Notification_Flow.md - 告警流程和处理
 * - models/alert.py - Alert数据模型
 */
```

#### 3. frontend/src/pages/AlertPolicies.tsx
添加注释：
```typescript
/**
 * 告警策略管理页面
 * 
 * 对齐源参考：
 * - 14_cloud_alert_policies.sql - 云端告警策略表
 * - TDPv2-0916.md - DangerLevel定义
 * - 25_Alarm_Notification_Flow.md - 策略配置说明
 */
```

---

### ✅ 测试文件（1个）

#### tests/full_system_test.py
```python
"""
对齐源参考：
- 所有db/*.sql文件定义的表结构
- models/*.py的数据模型
- TDPv2-0916.md和25_Alarm_Notification_Flow.md的告警协议
- 告警级别使用L1/L2/L3/L5/L8/L9/DISABLE
- 告警时间字段使用timestamp
"""
```

---

### ✅ 文档文件（1个）

#### 项目记录/2-源参考对照/1-数据库Schema对照/检查清单.md
```markdown
| 13_iot_monitor_alerts.sql | ✅ | ✅ | ✅ | ✅/✅/✅/✅ | ✅ | ✅ | **100%** | IoT设备报警配置表 ⭐ |
| 14_cloud_alert_policies.sql | ✅ | ✅ | ✅ | ✅/✅/✅/✅ | ✅ | ✅ | **100%** | 云端告警策略表 ⭐ |
| ⚠️ alerts（扩展） | ✅ | ✅ | ✅ | ✅/✅/✅/✅ | ✅ | ✅ | **100%** | 告警记录表（协议扩展，对齐TDPv2+25_Alarm_Notification_Flow.md）⭐ |
```

---

## 修正统计

### 文件修改
- 后端Python文件：10个
- 前端TypeScript文件：3个
- 测试文件：1个
- 文档文件：1个
- **总计：15个文件**

### 关键修正点
1. ✅ 字段名统一：`alert_level` 而非 `severity`
2. ✅ 时间字段统一：`timestamp` 而非 `alert_time`
3. ✅ 级别值统一：`L1/L2/L3/L5/L8/L9/DISABLE`
4. ✅ 状态值统一：`pending/acknowledged/resolved/dismissed`
5. ✅ 升级/抑制机制：对齐25_Alarm_Notification_Flow.md
6. ✅ 告警路由字段：对齐Location和Card模型
7. ✅ 用户alert配置：对齐User模型

---

## 源参考层次结构

```
源参考文档（优先级从高到低）
├── TDPv2-0916.md（协议层）
│   └── DangerLevel枚举定义：L1/L2/L3/L5/L8/L9
│   └── alert_timestamp字段
│
├── 25_Alarm_Notification_Flow.md（业务流程层）
│   ├── 告警级别说明和使用场景
│   ├── 告警路由机制（ActiveBed/Location）
│   ├── 用户过滤规则（alert_levels, alert_scope, alert_channels）
│   └── 升级/抑制/静默机制
│
├── 13_iot_monitor_alerts.sql（数据层-配置）
│   └── IoT设备报警配置表
│
├── 14_cloud_alert_policies.sql（数据层-策略）
│   └── 云端告警策略表
│
└── models/alert.py（实现层-扩展）
    └── Alert告警记录模型（协议扩展实现）
```

---

## 对齐验证

### ✅ 后端一致性
- models/alert.py ✅ 使用alert_level, timestamp
- utils/validation.py ✅ 验证alert_level, timestamp
- scripts/init_sample_data.py ✅ 创建alert_level, timestamp
- api/v1/alerts.py ✅ API使用alert_level
- services/alert_engine.py ✅ 处理L1/L2/L3级别

### ✅ 前端一致性
- types/index.ts ✅ Alert接口使用alert_level, timestamp
- pages/Alerts.tsx ✅ 显示L1/L2级别
- pages/AlertPolicies.tsx ✅ 配置DangerLevel

### ✅ 文档一致性
- README.md ✅ 描述L1-L8级别系统
- 检查清单.md ✅ 明确标注alerts为协议扩展

---

## 重要发现

### 1. Alert模型的特殊性
**Alert模型是协议扩展实现，源SQL中没有对应表定义！**

原因：
- 13_iot_monitor_alerts.sql：IoT设备配置
- 14_cloud_alert_policies.sql：云端策略
- **没有alert实例记录表**

Alert模型基于：
- TDPv2-0916.md协议定义
- 25_Alarm_Notification_Flow.md流程设计
- 实际业务需求扩展

### 2. 对齐的正确方法
```
源参考优先级：
协议文档（.md）> SQL表结构（.sql）> Model实现（.py）
```

当SQL缺失时：
1. 查找协议文档（TDPv2, 25_Alarm_Notification_Flow）
2. 查找相关技术文档（AI护理, Card_Permission等）
3. 基于协议实现扩展Model
4. 文档中明确标注为"协议扩展"

### 3. validation.py的错误
validation.py使用的`severity`和`alert_time`字段：
- ❌ 不在源参考中
- ❌ 不在Model定义中
- ❌ 不在协议文档中

**可能是早期版本遗留，已全面修正！**

---

## 下一步行动

### ✅ 已完成
1. ✅ 所有后端文件对齐
2. ✅ 所有前端文件对齐
3. ✅ 测试脚本对齐
4. ✅ 文档更新

### 📋 待执行
1. 提交所有修改到Git
2. 重新运行init_sample_data.py
3. 运行全自动测试
4. 验证告警创建和查询功能

---

## 教训总结

### ❌ 错误做法
1. **盲目修改**：为了测试通过而修改，而不是对齐源参考
2. **浅层搜索**：只看SQL文件，没有深入搜索协议文档
3. **忽视规范**：没有先检查项目规范就动手

### ✅ 正确做法
1. **深入搜索**：在整个项目目录（包括源参考文件）搜索相关内容
2. **协议优先**：协议文档的优先级高于SQL定义
3. **全面对齐**：后端+前端+文档+测试全面对齐
4. **明确标注**：在代码中明确标注对齐的源参考

---

**修正完成时间**: 2025-11-22 17:05  
**修正文件数**: 15个  
**对齐状态**: ✅ 完全对齐  
**下一步**: 提交并测试

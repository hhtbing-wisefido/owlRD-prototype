# ğŸ¯ ç³»ç»Ÿæ€§ä¿®å¤å»ºè®®

**ç”Ÿæˆæ—¶é—´**: 2025-11-21 13:22  
**é—®é¢˜å‘ç°**: å›å½’åˆè¡·éªŒè¯æ—¶å‘ç°å¤šå±‚å¯¹é½é—®é¢˜  
**é—®é¢˜ç­‰çº§**: HIGH PRIORITY

---

## ğŸ” å‘ç°çš„æ ¸å¿ƒé—®é¢˜

### 1. **ä¸‰å±‚ä¸ä¸€è‡´**

```
æºå‚è€ƒSQL (owdRD_github_clone) 
   â†“ (ä¸ä¸€è‡´!)
å†…éƒ¨Model (app/models/*.py)
   â†“ (ä¸ä¸€è‡´!)  
ç¤ºä¾‹æ•°æ®è„šæœ¬ (init_sample_data.py)
   â†“ (ä¸ä¸€è‡´!)
éªŒè¯è§„åˆ™ (app/utils/validation.py)
```

### 2. **å…·ä½“é—®é¢˜**

#### é—®é¢˜A: IoTæ•°æ®å­—æ®µå®Œå…¨ä¸åŒ¹é… âœ… å·²ä¿®å¤
- **Model**: æ­£ç¡®å¯¹é½ (`iot_data.py`)
- **ç¤ºä¾‹æ•°æ®**: ä½¿ç”¨é”™è¯¯å­—æ®µå âŒ â†’ âœ… å·²ä¿®å¤
- **ä¿®å¤**: `init_iot_data()` é‡å†™å®Œæˆ

#### é—®é¢˜B: ResidentséªŒè¯è§„åˆ™ä¸SQLä¸ä¸€è‡´ âŒ å¾…ä¿®å¤
- **SQLå®šä¹‰** (07_residents.sql):
  ```sql
  first_name VARCHAR(100),  -- å¯é€‰
  last_name VARCHAR(100) NOT NULL  -- å¿…éœ€
  -- æ²¡æœ‰ gender å­—æ®µï¼
  -- æ²¡æœ‰ date_of_birth å­—æ®µï¼
  ```
- **éªŒè¯è§„åˆ™** (validation.py):
  ```python
  first_name: å¿…éœ€ âŒ
  gender: å¿…éœ€ âŒ  (SQLä¸­æ ¹æœ¬æ²¡è¿™ä¸ªå­—æ®µ!)
  date_of_birth: å¿…éœ€ âŒ  (SQLä¸­æ ¹æœ¬æ²¡è¿™ä¸ªå­—æ®µ!)
  ```

#### é—®é¢˜C: æ‰‹æœºå·æ ¼å¼ âœ… å·²ä¿®å¤
- éªŒè¯è¦æ±‚çº¯æ•°å­—ï¼š`^1[3-9]\d{9}$`
- åŸç¤ºä¾‹æ•°æ®ï¼š`+86-138-0000-0001`
- ä¿®å¤ï¼šæ‰¹é‡æ›¿æ¢ä¸º `13800000001`

---

## ğŸ“‹ æ ¹æœ¬åŸå› 

### ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™äº›é—®é¢˜ï¼Ÿ

1. **æ²¡æœ‰è‡ªåŠ¨åŒ–éªŒè¯æœºåˆ¶**
   - æ²¡æœ‰è„šæœ¬éªŒè¯Modelä¸SQLæ˜¯å¦å¯¹é½
   - æ²¡æœ‰è„šæœ¬éªŒè¯ç¤ºä¾‹æ•°æ®æ˜¯å¦ç¬¦åˆModel
   - æ£€æŸ¥æ¸…å•æ˜¯æ‰‹å·¥æ ‡è®°ï¼Œæœªè‡ªåŠ¨åŒ–

2. **æ£€æŸ¥æ¸…å•æ ‡è®°ä¸å‡†ç¡®**
   - æ ‡è®°ä¸º100%ï¼Œä½†å®é™…æœªå¯¹é½
   - åªæ£€æŸ¥æ–‡ä»¶å­˜åœ¨ï¼Œæœªæ£€æŸ¥å­—æ®µå¯¹é½åº¦

3. **validation.pyå¯èƒ½æ˜¯æ—©æœŸç‰ˆæœ¬**
   - åŒ…å«SQLä¸­ä¸å­˜åœ¨çš„å­—æ®µéªŒè¯
   - ä¸å½“å‰Modelå®šä¹‰ä¸ä¸€è‡´

---

## ğŸ› ï¸ ç³»ç»Ÿæ€§ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆA: å¿«é€Ÿä¿®å¤ï¼ˆæ¨èï¼Œ30åˆ†é’Ÿï¼‰

**ç›®æ ‡**: è®©ç³»ç»Ÿèƒ½æ­£å¸¸è¿è¡Œï¼Œæ•°æ®èƒ½æ­£ç¡®åˆå§‹åŒ–

#### 1. ç¦ç”¨æˆ–ä¿®å¤residentséªŒè¯è§„åˆ™
```python
# app/utils/validation.py

# åˆ é™¤æˆ–æ³¨é‡Šæ‰ä¸å­˜åœ¨çš„å­—æ®µéªŒè¯
validators["residents"].add_rule("first_name", required, "åå­—ä¸èƒ½ä¸ºç©º")  # âŒ åˆ é™¤
validators["residents"].add_rule("gender", required, "æ€§åˆ«ä¸èƒ½ä¸ºç©º")  # âŒ åˆ é™¤ï¼ˆå­—æ®µä¸å­˜åœ¨ï¼‰
validators["residents"].add_rule("date_of_birth", required, "å‡ºç”Ÿæ—¥æœŸä¸èƒ½ä¸ºç©º")  # âŒ åˆ é™¤ï¼ˆå­—æ®µä¸å­˜åœ¨ï¼‰

# åªä¿ç•™SQLä¸­å®šä¹‰çš„å¿…éœ€å­—æ®µ
validators["residents"].add_rule("last_name", required, "åŒ¿åä»£ç§°ä¸èƒ½ä¸ºç©º")  # âœ… ä¿ç•™
validators["residents"].add_rule("resident_account", required, "ä½æˆ·è´¦å·ä¸èƒ½ä¸ºç©º")  # âœ… ä¿ç•™
```

#### 2. ä¿®å¤init_sample_data.pyçš„residentsæ•°æ®
```python
# ç§»é™¤ä¸å­˜åœ¨çš„å­—æ®µï¼Œåªä½¿ç”¨SQLå®šä¹‰çš„å­—æ®µ
{
    "resident_id": SAMPLE_RESIDENT_ID,
    "tenant_id": SAMPLE_TENANT_ID,
    "HIS_resident_id": "HIS-R-2023-001",
    "HIS_resident_bed_id": "HIS-BED-101-1",
    "HIS_resident_status": "active",
    "resident_account": "R001",
    "first_name": None,  # å¯é€‰
    "last_name": "æ´»åŠ›è€äºº",  # å¿…éœ€
    "anonymous_name": "æ´»åŠ›è€äºº",
    "is_institutional": True,
    "location_id": SAMPLE_LOCATION_ID,
    "bed_id": SAMPLE_BED_ID,
    "admission_date": "2024-05-25",
    "status": "active",
    "metadata": {},
    "phone_hash": hash_contact("13811111111"),
    "email_hash": hash_contact("resident001@example.com"),
    "family_tag": "FAMILY-WANG",
    "family_member_account_1": None,
    "can_view_status": True,
    # âŒ ç§»é™¤ï¼šgender, date_of_birthï¼ˆSQLä¸­ä¸å­˜åœ¨ï¼‰
}
```

#### 3. éªŒè¯å¹¶è¿è¡Œ
```bash
# æ¸…ç©ºæ•°æ®
rm app/data/*.json

# è¿è¡Œåˆå§‹åŒ–
python init_sample_data.py

# åº”è¯¥æˆåŠŸå®Œæˆï¼
```

---

### æ–¹æ¡ˆB: å½»åº•ä¿®å¤ï¼ˆå®Œç¾ï¼Œä½†éœ€è¦2-3å°æ—¶ï¼‰

**ç›®æ ‡**: å»ºç«‹è‡ªåŠ¨åŒ–éªŒè¯æœºåˆ¶ï¼Œé˜²æ­¢æœªæ¥å†å‡ºç°é—®é¢˜

#### 1. åˆ›å»ºè‡ªåŠ¨åŒ–å¯¹é½éªŒè¯è„šæœ¬
```python
# scripts/validate_alignment.py

"""éªŒè¯æºSQLã€Modelã€ç¤ºä¾‹æ•°æ®ä¸‰è€…å¯¹é½"""

import sqlparse
from pathlib import Path

def extract_sql_fields(sql_file):
    """ä»SQLæ–‡ä»¶æå–å­—æ®µå®šä¹‰"""
    pass

def extract_model_fields(model_file):
    """ä»Pydantic Modelæå–å­—æ®µå®šä¹‰"""
    pass

def validate_sample_data(model_class, sample_data):
    """ç”¨ModeléªŒè¯ç¤ºä¾‹æ•°æ®"""
    try:
        model_class(**sample_data)
        return True, None
    except Exception as e:
        return False, str(e)

def main():
    # å¯¹æ¯”æ‰€æœ‰è¡¨
    tables = [
        ("01_tenants.sql", "tenant.py", "tenants"),
        ("07_residents.sql", "resident.py", "residents"),
        ("12_iot_timeseries.sql", "iot_data.py", "iot_timeseries"),
        # ... å…¶ä»–è¡¨
    ]
    
    for sql_file, model_file, collection in tables:
        print(f"\næ£€æŸ¥ {collection}...")
        sql_fields = extract_sql_fields(sql_file)
        model_fields = extract_model_fields(model_file)
        
        # å¯¹æ¯”å­—æ®µ
        missing = sql_fields - model_fields
        extra = model_fields - sql_fields
        
        if missing:
            print(f"  âŒ Modelç¼ºå°‘å­—æ®µ: {missing}")
        if extra:
            print(f"  âš ï¸  Modelå¤šä½™å­—æ®µ: {extra}")
        
        # éªŒè¯ç¤ºä¾‹æ•°æ®
        samples = load_sample_data(collection)
        for sample in samples:
            valid, error = validate_sample_data(ModelClass, sample)
            if not valid:
                print(f"  âŒ ç¤ºä¾‹æ•°æ®éªŒè¯å¤±è´¥: {error}")
```

#### 2. é›†æˆåˆ°CIæµç¨‹
```yaml
# .github/workflows/validate.yml
name: Validate Alignment

on: [push, pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run alignment validation
        run: python scripts/validate_alignment.py
```

#### 3. æ›´æ–°æ£€æŸ¥æ¸…å•ç”Ÿæˆè„šæœ¬
```python
# scripts/update_checklist.py

"""è‡ªåŠ¨æ›´æ–°æ£€æŸ¥æ¸…å•ï¼ŒåŸºäºå®é™…éªŒè¯ç»“æœ"""

def check_model_alignment(sql_file, model_file):
    """æ£€æŸ¥Modelæ˜¯å¦å¯¹é½SQL"""
    # è¿”å›ç™¾åˆ†æ¯”
    pass

def check_api_exists(api_file):
    """æ£€æŸ¥APIæ˜¯å¦å­˜åœ¨"""
    pass

def check_sample_data_valid(collection, model_class):
    """æ£€æŸ¥ç¤ºä¾‹æ•°æ®æ˜¯å¦æœ‰æ•ˆ"""
    pass

def update_checklist():
    for table in tables:
        model_score = check_model_alignment(...)
        api_score = check_api_exists(...)
        data_score = check_sample_data_valid(...)
        
        # è‡ªåŠ¨ç”Ÿæˆæ£€æŸ¥æ¸…å•
        checklist.add_row(
            model="âœ…" if model_score == 100 else f"âš ï¸{model_score}%",
            api="âœ…" if api_exists else "âŒ",
            data="âœ…" if data_valid else "âŒ"
        )
```

---

## ğŸ’¡ ç«‹å³è¡ŒåŠ¨å»ºè®®

### æˆ‘çš„ä¸“ä¸šå»ºè®®ï¼šå…ˆæ‰§è¡Œæ–¹æ¡ˆAï¼Œå†è€ƒè™‘æ–¹æ¡ˆB

**ç†ç”±**:
1. âœ… æ–¹æ¡ˆAèƒ½ç«‹å³è§£å†³å½“å‰é—®é¢˜ï¼ˆ30åˆ†é’Ÿï¼‰
2. âœ… è®©ç³»ç»Ÿèƒ½æ­£å¸¸è¿è¡Œå¹¶æ¼”ç¤º
3. âœ… ä¸ºæ–¹æ¡ˆBæ‰“ä¸‹åŸºç¡€
4. â° æ–¹æ¡ˆBéœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œä¸é€‚åˆç°åœ¨ç´§æ€¥ä¿®å¤

### ä¸‹ä¸€æ­¥ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰:

1. **ç«‹å³** - ä¿®å¤validation.pyçš„residentsè§„åˆ™ï¼ˆ10åˆ†é’Ÿï¼‰
2. **ç«‹å³** - æ¸…ç©ºæ•°æ®å¹¶é‡æ–°åˆå§‹åŒ–ï¼ˆ5åˆ†é’Ÿï¼‰
3. **ç«‹å³** - æµ‹è¯•åç«¯APIï¼ˆ10åˆ†é’Ÿï¼‰
4. **ä»Šå¤©** - æµ‹è¯•å‰ç«¯é›†æˆï¼ˆ30åˆ†é’Ÿï¼‰
5. **ä»Šå¤©** - æäº¤æ‰€æœ‰ä¿®å¤ï¼ˆ10åˆ†é’Ÿï¼‰
6. **åç»­** - å®æ–½æ–¹æ¡ˆBçš„è‡ªåŠ¨åŒ–éªŒè¯ï¼ˆ2-3å°æ—¶ï¼‰

---

## â“ éœ€è¦æ‚¨ç¡®è®¤çš„é—®é¢˜

1. **æ˜¯å¦æ¥å—æ–¹æ¡ˆAçš„å¿«é€Ÿä¿®å¤ï¼Ÿ**
2. **validation.pyä¸­çš„genderå’Œdate_of_birthå­—æ®µæ˜¯å¦éœ€è¦ä¿ç•™ï¼Ÿ**
   - å¦‚æœéœ€è¦ï¼Œè¯´æ˜07_residents.sqléœ€è¦æ·»åŠ è¿™äº›å­—æ®µ
   - å¦‚æœä¸éœ€è¦ï¼Œåº”è¯¥ä»validation.pyä¸­åˆ é™¤
3. **æ˜¯å¦éœ€è¦ç«‹å³å®æ–½æ–¹æ¡ˆBçš„è‡ªåŠ¨åŒ–éªŒè¯ï¼Ÿ**

---

**ç­‰å¾…æ‚¨çš„å†³ç­–ï¼Œç„¶åæˆ‘ç«‹å³æ‰§è¡Œï¼**

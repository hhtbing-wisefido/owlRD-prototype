# 规范强制执行机制

**创建日期**: 2025-11-25  
**目的**: 通过技术手段强制执行项目规范，防止违规操作  
**状态**: ✅ 已启用

---

## 🎯 执行机制概述

### 三层防护体系

```
1️⃣ Git Hook (自动) → 每次提交前强制检查
2️⃣ 手动检查 (主动) → 定期运行检查脚本  
3️⃣ 规则文档 (参考) → 开发时参考规范
```

---

## 🛡️ 第一层：Git Hook 强制检查

### 位置
`.git/hooks/pre-commit`

### 执行时机
**每次 `git commit` 时自动运行**

### 检查内容

#### 步骤1: 目录规范检查（强制）
运行 `scripts/check_directory_standards.py`

**检查项目**：
- ✅ 顶层目录结构完整性（8个分类目录）
- ✅ 子目录结构规范性
- ✅ 根目录文件规范（只允许README.md和项目状态.json）
- ✅ 禁止临时文件
- ✅ 聊天记录完整性

**检查失败的后果**：
```
❌ 提交被阻止（git commit失败）
📋 显示详细错误信息
💡 提供修复建议
```

#### 步骤2: 自动更新项目状态
运行 `scripts/update_project_status.py`

**更新内容**：
- 代码行数统计
- 文档数量统计  
- Git提交次数
- 服务运行状态

**检查失败的后果**：
```
⚠️  只显示警告，不阻止提交
```

---

## 🔍 第二层：手动检查

### 快捷命令

#### Windows
```bash
# 进入项目根目录
cd D:\test_Project\owlRD-原型项目

# 运行检查
scripts\check_standards.bat
```

#### Linux/Mac
```bash
python scripts/check_directory_standards.py
```

### 何时使用
- ✅ 开发完成后，提交前主动检查
- ✅ 重构目录结构后
- ✅ 添加新文件/目录后
- ✅ 定期检查（每周）

---

## 📚 第三层：规则文档

### 核心规范文档

| 文档 | 位置 | 用途 |
|------|------|------|
| **文件操作强制检查清单.md** | `项目记录/6-开发规范/` | 5步检查流程 |
| **项目根目录管理规范.md** | `项目记录/6-开发规范/` | 根目录规范 |
| **文档管理最佳实践.md** | `项目记录/6-开发规范/` | 文档命名规范 |

### 使用场景
- 创建新文件前查阅
- 不确定文件位置时参考
- 命名规范不清楚时查看

---

## ⚙️ 执行流程示例

### 正常提交流程

```bash
# 1. 修改代码
vim backend/app/main.py

# 2. 提交更改
git add .
git commit -m "feat: add new feature"

# 3. Git Hook 自动执行
================================================================================
🛡️  Git Pre-commit 检查
================================================================================

📋 步骤1/2: 检查目录规范（强制）...
--------------------------------------------------------------------------------
🔍 项目记录目录规范检查
...
✅ 检查完成：目录结构完全符合规范！

✅ 目录规范检查通过

🔄 步骤2/2: 更新项目状态...
--------------------------------------------------------------------------------
✅ 项目状态已更新

================================================================================
✅ 所有检查通过，允许提交
================================================================================

# 4. 提交成功
[main abc1234] feat: add new feature
```

### 检查失败流程

```bash
# 1. 在根目录创建了不该存在的文件
echo "test" > 项目记录/临时文件.md

# 2. 尝试提交
git commit -m "test"

# 3. Git Hook 检测到问题
================================================================================
🛡️  Git Pre-commit 检查
================================================================================

📋 步骤1/2: 检查目录规范（强制）...
--------------------------------------------------------------------------------
❌ 发现 1 个问题:
  ❌ 根目录不应包含文件: 临时文件.md

================================================================================
❌ 目录规范检查失败！
================================================================================

请修复以上问题后再提交。

修复建议：
  1. 查看上面的错误信息
  2. 移动/删除不符合规范的文件
  3. 参考: 项目记录/6-开发规范/文件操作强制检查清单.md

================================================================================

# 4. 提交被阻止（返回错误码1）
```

---

## 🔧 技术实现细节

### Git Hook 工作原理

```python
# .git/hooks/pre-commit

1. 运行检查脚本
   result = subprocess.run([python, check_script])

2. 判断返回码
   if result.returncode != 0:
       sys.exit(1)  # 阻止提交
   
3. 继续其他检查
   update_project_status()
   
4. 允许提交
   sys.exit(0)
```

### 检查脚本核心逻辑

```python
# scripts/check_directory_standards.py

class DirectoryStandardChecker:
    def check(self):
        # 检查顶层目录
        self.check_top_directories()
        
        # 检查子目录
        self.check_sub_directories()
        
        # 检查根目录文件
        self.check_root_files()
        
        # 检查临时文件
        self.check_temporary_files()
        
        # 返回结果
        return len(self.issues) == 0  # 有问题返回False
```

---

## 🚫 常见违规示例

### 违规1: 在根目录创建文件

**错误操作**:
```bash
# 在项目记录根目录创建文档
echo "test" > 项目记录/新功能说明.md
```

**检查结果**:
```
❌ 根目录不应包含文件: 新功能说明.md
```

**修正方法**:
```bash
# 移动到正确位置
Move-Item "项目记录/新功能说明.md" "项目记录/3-功能说明/新功能说明.md"
```

### 违规2: 创建不符合规范的目录

**错误操作**:
```bash
# 在项目记录下创建任意目录
mkdir 项目记录/我的文档
```

**检查结果**:
```
⚠️  未预期的目录: 我的文档
```

**修正方法**:
```bash
# 删除或移动到合适位置
Remove-Item "项目记录/我的文档" -Recurse
```

---

## 📊 执行统计

### 自动记录

每次检查会生成报告：
- 位置: `owlRD-prototype/tests/test_reports/directory_check_report.json`
- 内容: 检查时间、统计数据、问题列表、警告列表

### 查看历史

```bash
# 查看最新检查报告
cat owlRD-prototype/tests/test_reports/directory_check_report.json
```

---

## 🎓 最佳实践

### ✅ 应该做的

1. **提交前主动检查**
   ```bash
   scripts\check_standards.bat
   ```

2. **创建文件前参考规范**
   - 查看"文件操作强制检查清单.md"
   - 完成5步检查

3. **定期清理**
   - 每周检查一次
   - 及时归档过时文件

4. **遵守规范**
   - 理解规范的意义
   - 养成良好习惯

### ❌ 不应该做的

1. **绕过检查**
   - ❌ 使用 `git commit --no-verify`
   - ❌ 修改Git Hook跳过检查

2. **忽视警告**
   - ❌ 看到警告继续违规
   - ❌ 不修复检查出的问题

3. **随意修改规范**
   - ❌ 未经讨论修改规则
   - ❌ 删除检查机制

---

## 🔄 维护和更新

### 规范更新流程

1. **发现新问题**
   - 记录违规案例
   - 分析根本原因

2. **更新规范文档**
   - 修改规范文档
   - 添加新的检查项

3. **更新检查脚本**
   - 修改 `check_directory_standards.py`
   - 添加新的检查逻辑

4. **测试验证**
   - 运行检查脚本
   - 确认能检测到问题

5. **团队通知**
   - 更新文档
   - 通知团队成员

---

## 🆘 问题排查

### 问题1: Git Hook不执行

**症状**: 提交时没有看到检查输出

**原因**: 
- Hook文件没有执行权限（Linux/Mac）
- Hook文件路径错误

**解决**:
```bash
# Linux/Mac
chmod +x .git/hooks/pre-commit

# Windows (通常不需要)
# 确认Python路径正确
```

### 问题2: 检查脚本报错

**症状**: 提交时出现Python错误

**原因**:
- Python环境问题
- 脚本路径不对

**解决**:
```bash
# 测试脚本
python scripts/check_directory_standards.py

# 检查Python版本
python --version
```

### 问题3: 误报问题

**症状**: 检查报告误判为问题

**原因**:
- 规范定义不完整
- 检查逻辑有误

**解决**:
1. 确认是否真的违规
2. 如果是误报，更新检查脚本
3. 如果是真问题，修正文件位置

---

## 📈 效果评估

### 实施前
```
❌ 规则只在文档中，无法强制
❌ AI助手容易违反规则
❌ 项目目录经常混乱
❌ 需要人工定期清理
```

### 实施后
```
✅ 每次提交自动检查
✅ 违规操作被立即阻止
✅ 项目目录始终规范
✅ 问题在产生时就被发现
```

---

**维护者**: 项目团队  
**最后更新**: 2025-11-25  
**版本**: 1.0  
**状态**: ✅ 生效中

---

**说明**:
- 本机制为强制性机制，不可绕过
- 所有团队成员必须遵守
- 违反规范的提交会被自动拒绝
- 定期更新检查逻辑以适应新需求

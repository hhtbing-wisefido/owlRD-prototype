# 规范强制执行机制

**创建日期**: 2025-11-25  
**目的**: 通过技术手段强制执行项目规范，防止违规操作  
**状?*: ?已启?

---

## 🎯 执行机制概述

### 三层防护体系

```
1️⃣ Git Hook (自动) ?每次提交前强制检?
2️⃣ 手动检?(主动) ?定期运行检查脚? 
3️⃣ 规则文档 (参? ?开发时参考规?
```

---

## 🛡?第一层：Git Hook 强制检?

### 位置
`.git/hooks/pre-commit`

### 执行时机
**每次 `git commit` 时自动运?*

### 检查内?

#### 步骤1: 目录规范检查（强制?
运行 `scripts/check_directory_standards.py`

**检查项?*?
- ?顶层目录结构完整性（8个分类目录）
- ?子目录结构规范?
- ?根目录文件规范（只允许README.md和项目状?json?
- ?禁止临时文件
- ?聊天记录完整?

**检查失败的后果**?
```
?提交被阻止（git commit失败?
📋 显示详细错误信息
💡 提供修复建议
```

#### 步骤2: 自动更新项目状?
运行 `scripts/update_project_status.py`

**更新内容**?
- 代码行数统计
- 文档数量统计  
- Git提交次数
- 服务运行状?

**检查失败的后果**?
```
⚠️  只显示警告，不阻止提?
```

---

## 🔍 第二层：手动检?

### 快捷命令

#### Windows
```bash
# 进入项目根目?
cd D:\test_Project\owlRD-原型项目

# 运行检?
scripts\check_standards.bat
```

#### Linux/Mac
```bash
python scripts/check_directory_standards.py
```

### 何时使用
- ?开发完成后，提交前主动检?
- ?重构目录结构?
- ?添加新文?目录?
- ?定期检查（每周?

---

## 📚 第三层：规则文档

### 核心规范文档

| 文档 | 位置 | 用?|
|------|------|------|
| **文件操作强制检查清?md** | `项目记录/6-开发规?` | 5步检查流?|
| **项目根目录管理规?md** | `项目记录/6-开发规?` | 根目录规?|
| **文档管理最佳实?md** | `项目记录/6-开发规?` | 文档命名规范 |

### 使用场景
- 创建新文件前查阅
- 不确定文件位置时参?
- 命名规范不清楚时查看

---

## ⚙️ 执行流程示例

### 正常提交流程

```bash
# 1. 修改代码
vim backend/app/main.py

# 2. 提交更改
git add .
git commit -m "feat: add new feature"

# 3. Git Hook 自动执行
================================================================================
🛡? Git Pre-commit 检?
================================================================================

📋 步骤1/2: 检查目录规范（强制?..
--------------------------------------------------------------------------------
🔍 项目记录目录规范检?
...
?检查完成：目录结构完全符合规范?

?目录规范检查通过

🔄 步骤2/2: 更新项目状?..
--------------------------------------------------------------------------------
?项目状态已更新

================================================================================
?所有检查通过，允许提?
================================================================================

# 4. 提交成功
[main abc1234] feat: add new feature
```

### 检查失败流?

```bash
# 1. 在根目录创建了不该存在的文件
echo "test" > 项目记录/临时文件.md

# 2. 尝试提交
git commit -m "test"

# 3. Git Hook 检测到问题
================================================================================
🛡? Git Pre-commit 检?
================================================================================

📋 步骤1/2: 检查目录规范（强制?..
--------------------------------------------------------------------------------
?发现 1 个问?
  ?根目录不应包含文? 临时文件.md

================================================================================
?目录规范检查失败！
================================================================================

请修复以上问题后再提交?

修复建议?
  1. 查看上面的错误信?
  2. 移动/删除不符合规范的文件
  3. 参? 项目记录/6-开发规?文件操作强制检查清?md

================================================================================

# 4. 提交被阻止（返回错误??
```

---

## 🔧 技术实现细?

### Git Hook 工作原理

```python
# .git/hooks/pre-commit

1. 运行检查脚?
   result = subprocess.run([python, check_script])

2. 判断返回?
   if result.returncode != 0:
       sys.exit(1)  # 阻止提交
   
3. 继续其他检?
   update_project_status()
   
4. 允许提交
   sys.exit(0)
```

### 检查脚本核心逻辑

```python
# scripts/check_directory_standards.py

class DirectoryStandardChecker:
    def check(self):
        # 检查顶层目?
        self.check_top_directories()
        
        # 检查子目录
        self.check_sub_directories()
        
        # 检查根目录文件
        self.check_root_files()
        
        # 检查临时文?
        self.check_temporary_files()
        
        # 返回结果
        return len(self.issues) == 0  # 有问题返回False
```

---

## 🚫 常见违规示例

### 违规1: 在根目录创建文件

**错误操作**:
```bash
# 在项目记录根目录创建文档
echo "test" > 项目记录/新功能说?md
```

**检查结?*:
```
?根目录不应包含文? 新功能说?md
```

**修正方法**:
```bash
# 移动到正确位?
Move-Item "项目记录/新功能说?md" "项目记录/3-功能说明/新功能说?md"
```

### 违规2: 创建不符合规范的目录

**错误操作**:
```bash
# 在项目记录下创建任意目录
mkdir 项目记录/我的文档
```

**检查结?*:
```
⚠️  未预期的目录: 我的文档
```

**修正方法**:
```bash
# 删除或移动到合适位?
Remove-Item "项目记录/我的文档" -Recurse
```

---

## 📊 执行统计

### 自动记录

每次检查会生成报告?
- 位置: `owlRD-prototype/tests/test_reports/directory_check_report.json`
- 内容: 检查时间、统计数据、问题列表、警告列?

### 查看历史

```bash
# 查看最新检查报?
cat owlRD-prototype/tests/test_reports/directory_check_report.json
```

---

## 🎓 最佳实?

### ?应该做的

1. **提交前主动检?*
   ```bash
   scripts\check_standards.bat
   ```

2. **创建文件前参考规?*
   - 查看"文件操作强制检查清?md"
   - 完成5步检?

3. **定期清理**
   - 每周检查一?
   - 及时归档过时文件

4. **遵守规范**
   - 理解规范的意?
   - 养成良好习惯

### ?不应该做?

1. **绕过检?*
   - ?使用 `git commit --no-verify`
   - ?修改Git Hook跳过检?

2. **忽视警告**
   - ?看到警告继续违规
   - ?不修复检查出的问?

3. **随意修改规范**
   - ?未经讨论修改规则
   - ?删除检查机?

---

## 🔄 维护和更?

### 规范更新流程

1. **发现新问?*
   - 记录违规案例
   - 分析根本原因

2. **更新规范文档**
   - 修改规范文档
   - 添加新的检查项

3. **更新检查脚?*
   - 修改 `check_directory_standards.py`
   - 添加新的检查逻辑

4. **测试验证**
   - 运行检查脚?
   - 确认能检测到问题

5. **团队通知**
   - 更新文档
   - 通知团队成员

---

## 🆘 问题排查

### 问题1: Git Hook不执?

**症状**: 提交时没有看到检查输?

**原因**: 
- Hook文件没有执行权限（Linux/Mac?
- Hook文件路径错误

**解决**:
```bash
# Linux/Mac
chmod +x .git/hooks/pre-commit

# Windows (通常不需?
# 确认Python路径正确
```

### 问题2: 检查脚本报?

**症状**: 提交时出现Python错误

**原因**:
- Python环境问题
- 脚本路径不对

**解决**:
```bash
# 测试脚本
python scripts/check_directory_standards.py

# 检查Python版本
python --version
```

### 问题3: 误报问题

**症状**: 检查报告误判为问题

**原因**:
- 规范定义不完?
- 检查逻辑有误

**解决**:
1. 确认是否真的违规
2. 如果是误报，更新检查脚?
3. 如果是真问题，修正文件位?

---

## 📈 效果评估

### 实施?
```
?规则只在文档中，无法强制
?AI助手容易违反规则
?项目目录经常混乱
?需要人工定期清?
```

### 实施?
```
?每次提交自动检?
?违规操作被立即阻?
?项目目录始终规范
?问题在产生时就被发现
```

---

**维护?*: 项目团队  
**最后更?*: 2025-11-25  
**版本**: 1.0  
**状?*: ?生效?

---

**说明**:
- 本机制为强制性机制，不可绕过
- 所有团队成员必须遵?
- 违反规范的提交会被自动拒?
- 定期更新检查逻辑以适应新需?

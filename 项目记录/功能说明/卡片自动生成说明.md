# 卡片自动生成说明 (Card Functions)

> 对应SQL: `19_card_functions.sql`  
> 创建时间: 2025-11-21

---

## 功能概述

卡片自动生成系统根据位置(Location)、房间(Room)、床位(Bed)的配置，自动创建和维护告警路由卡片，实现智能化的告警分发。

---

## 核心概念

### ActiveBed vs NonActiveBed

- **ActiveBed**: 活动床位，有住户入住且有IoT设备监控
- **NonActiveBed**: 非活动床位，空床或无设备监控

### 卡片类型

1. **ActiveBed卡片**: 针对单个活动床位的精确告警路由
2. **Location卡片**: 位置级别的通用告警路由（公共空间、多人房间）

---

## 业务逻辑

### 卡片创建规则

#### 场景1：单个ActiveBed
```
条件: Location有且仅有1个ActiveBed
↓
创建: 1个ActiveBed卡片
卡片名称: {resident_name} 或 {location_name}
卡片地址: {location_name} - {bed_name}
```

#### 场景2：多个ActiveBed
```
条件: Location有多个ActiveBed
↓
创建: N个ActiveBed卡片 + 1个Location卡片
ActiveBed卡片: 每个床位一个
Location卡片: 位置通用卡片
```

#### 场景3：无ActiveBed
```
条件: Location没有ActiveBed
↓
创建: 1个Location卡片
用途: 公共空间告警路由
```

---

## 卡片命名规则

### ActiveBed卡片名称优先级
1. 住户姓名 (resident.last_name + first_name)
2. 位置名称 (location.location_name)
3. 床位名称 (bed.bed_name)

**示例**：
```
场景: Location "Room 201", Bed "A", Resident "张三"
→ 卡片名称: "张三"
→ 卡片地址: "Room 201 - A"
```

### Location卡片名称
- 直接使用 location.location_name
- 示例: "大厅"、"走廊"、"Room 201"

---

## 数据模型

### Card Fields

| 字段 | 类型 | 说明 |
|------|------|------|
| card_id | UUID | 卡片ID |
| tenant_id | UUID | 租户ID |
| card_type | string | 卡片类型（ActiveBed/Location）|
| bed_id | UUID | 床位ID（ActiveBed卡片）|
| location_id | UUID | 位置ID |
| card_name | string | 卡片名称 |
| card_address | string | 卡片地址 |
| resident_id | UUID | 住户ID（ActiveBed卡片）|
| is_public_space | boolean | 是否公共空间 |
| routing_alert_user_ids | UUID[] | 告警接收者ID列表 |
| is_active | boolean | 是否激活 |

---

## API端点

### 1. 为指定Location重新生成卡片
```
POST /api/v1/card_functions/regenerate_location
```

**请求体**：
```json
{
  "location_id": "uuid",
  "tenant_id": "uuid"
}
```

**功能**：
- 删除该Location的所有现有卡片
- 重新计算ActiveBed
- 按规则生成新卡片
- 返回生成的卡片列表

### 2. 批量重新生成所有卡片
```
POST /api/v1/card_functions/regenerate_all
```

**请求体**：
```json
{
  "tenant_id": "uuid"
}
```

**功能**：
- 删除租户所有卡片
- 遍历所有Location
- 批量重新生成卡片

### 3. 预览卡片生成结果
```
POST /api/v1/card_functions/preview
```

**请求体**：
```json
{
  "location_id": "uuid",
  "tenant_id": "uuid"
}
```

**功能**：
- 不实际创建卡片
- 返回将要生成的卡片信息
- 用于验证生成逻辑

---

## 核心服务

### CardService (card_service.py)

#### 1. calculate_card_address()
计算卡片地址

```python
def calculate_card_address(location, bed):
    """
    返回: "{location_name} - {bed_name}"
    示例: "Room 201 - A"
    """
```

#### 2. is_active_bed()
判断是否为ActiveBed

```python
def is_active_bed(bed, residents, devices):
    """
    条件:
    1. bed_type == "ActiveBed"
    2. resident_id 不为空
    3. 有绑定的设备且设备在线
    """
```

#### 3. generate_cards_for_location()
为Location生成卡片

```python
def generate_cards_for_location(location_id, tenant_id):
    """
    主逻辑:
    1. 查询Location、Rooms、Beds
    2. 识别ActiveBeds
    3. 按规则创建卡片
    4. 返回卡片列表
    """
```

---

## 使用场景

### 场景1：住户入住
```
操作: 分配resident_id到bed, 设备上线
触发: generate_cards_for_location()
结果: 创建ActiveBed卡片
```

### 场景2：住户出院
```
操作: 清空bed.resident_id
触发: regenerate_location()
结果: 删除ActiveBed卡片，可能创建Location卡片
```

### 场景3：设备故障
```
操作: 设备状态变为offline
触发: is_active_bed() 返回False
结果: 重新生成为Location卡片
```

### 场景4：批量初始化
```
操作: 系统初次部署
触发: regenerate_all()
结果: 为所有Location生成卡片
```

---

## 告警路由关系

```
告警发生 → 查找设备 → 获取bed_id → 查找卡片
                                      ↓
                    ActiveBed卡片 → 精确路由到住户护理团队
                    Location卡片 → 路由到区域负责人
```

### 路由优先级
1. 优先使用ActiveBed卡片（精确）
2. 降级使用Location卡片（通用）
3. 最后使用租户默认接收者

---

## 自动触发机制

### 需要重新生成卡片的情况

1. **Resident变更**
   - 入住/出院
   - 更换床位
   - 状态变更

2. **Bed变更**
   - bed_type变更
   - resident_id变更
   - 设备绑定变更

3. **Device变更**
   - 设备上线/下线
   - 设备绑定变更

4. **Location变更**
   - 配置变更
   - Room/Bed增删

---

## 实现状态

- ✅ 后端Service (card_service.py) - 核心业务逻辑
- ✅ 后端API (card_functions.py) - 3个端点
- ❌ 示例数据（通过API动态生成）
- ✅ 前端类型 (Card已有)
- ⏳ 前端页面（待开发）
- ✅ 文档

**完成度**: 67%

---

## 测试示例

### Python测试
```python
from app.services.card_service import CardService

service = CardService()

# 为Location生成卡片
cards = service.generate_cards_for_location(
    location_id="xxx",
    tenant_id="yyy"
)

print(f"生成了 {len(cards)} 个卡片")
for card in cards:
    print(f"{card['card_type']}: {card['card_name']}")
```

---

## 注意事项

1. **性能考虑**
   - 大量Location时避免频繁regenerate_all
   - 使用preview验证后再执行
   - 考虑异步处理

2. **数据一致性**
   - 删除Resident时清理卡片
   - 删除Device时更新卡片
   - 事务性操作

3. **告警路由**
   - 确保每个Location至少有1个卡片
   - 验证routing_alert_user_ids有效
   - 处理空接收者情况

---

## 参考文档

- `20_Card_Creation_Rules_Final.md` - 详细创建规则
- `23_Card_Functions_Usage.md` - 使用指南
- `25_Alarm_Notification_Flow.md` - 告警流程

---

**最后更新**: 2025-11-21

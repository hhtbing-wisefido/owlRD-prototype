# 位置房间床位管理说明 (Locations, Rooms, Beds)

> 对应SQL: `04_locations.sql`, `05_rooms.sql`, `06_beds.sql`  
> 创建时间: 2025-11-21

---

## 功能概述

三层空间管理架构，提供完整的养老院/家庭护理场所管理功能，支持设备绑定、住户分配和告警路由配置。

```
Location (位置/场所)
  └── Room (房间)
        └── Bed (床位)
```

---

## 一、Location (位置/场所)

### 数据模型

| 字段 | 类型 | 说明 |
|------|------|------|
| location_id | UUID | 位置ID（主键）|
| tenant_id | UUID | 租户ID |
| **位置标识** | | |
| location_tag | string | 位置标签（如"A院区主楼"）|
| location_name | string | 位置名称（如"201"、"E203"）|
| **Institutional场景** | | |
| building | string | 楼栋（如"Building A"）|
| floor | string | 楼层（如"1F"、"2F"）|
| area_id | string | 区域ID（如"Memory Care Unit"）|
| door_number | string | 门牌号/房间号 |
| **场景配置** | | |
| layout_config | JSON | 房间布局配置（vue_radar格式）|
| location_type | string | 场景类型：Institutional/HomeCare |
| primary_resident_id | UUID | 主要关联住户ID |
| **空间属性** | | |
| is_public_space | boolean | 是否公共空间（大厅、走廊）|
| is_multi_person_room | boolean | 是否多人房间 |
| **告警路由** | | |
| timezone | string | IANA时区（如"America/Los_Angeles"）|
| alert_user_ids | UUID[] | 告警接收者ID列表 |
| alert_tags | string[] | 告警接收者标签组 |
| is_active | boolean | 是否启用监控 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

### API端点

#### 1. 获取位置列表
```
GET /api/v1/locations?tenant_id={id}
```

#### 2. 获取位置详情
```
GET /api/v1/locations/{location_id}
```

#### 3. 创建位置
```
POST /api/v1/locations
```

**请求体示例**：
```json
{
  "tenant_id": "uuid",
  "location_name": "Room 201",
  "building": "Main Building",
  "floor": "2F",
  "door_number": "201",
  "location_type": "Institutional",
  "is_public_space": false,
  "is_multi_person_room": false,
  "timezone": "America/Los_Angeles",
  "alert_user_ids": ["user1", "user2"],
  "is_active": true
}
```

#### 4. 更新位置
```
PUT /api/v1/locations/{location_id}
```

#### 5. 删除位置
```
DELETE /api/v1/locations/{location_id}
```

### 使用场景

#### 场景1：机构式养老院
```json
{
  "location_type": "Institutional",
  "building": "A栋",
  "floor": "3F",
  "door_number": "301",
  "is_multi_person_room": true
}
```

#### 场景2：家庭护理
```json
{
  "location_type": "HomeCare",
  "location_name": "Home-001",
  "primary_resident_id": "resident_uuid",
  "is_public_space": false
}
```

#### 场景3：公共空间
```json
{
  "location_name": "Main Lobby",
  "is_public_space": true,
  "alert_user_ids": ["security_staff"]
}
```

---

## 二、Room (房间)

### 数据模型

| 字段 | 类型 | 说明 |
|------|------|------|
| room_id | UUID | 房间ID（主键）|
| location_id | UUID | 所属位置ID |
| tenant_id | UUID | 租户ID |
| is_default | boolean | 是否默认房间 |
| room_name | string | 房间名称（如"Bedroom"、"Bathroom"）|
| is_active | boolean | 是否启用 |
| layout_config | JSON | 房间级独立布局配置 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

### API端点

#### 1. 获取房间列表
```
GET /api/v1/rooms?location_id={id}
```

#### 2. 获取房间详情
```
GET /api/v1/rooms/{room_id}
```

#### 3. 创建房间
```
POST /api/v1/rooms
```

**请求体示例**：
```json
{
  "location_id": "location_uuid",
  "tenant_id": "tenant_uuid",
  "room_name": "Bedroom",
  "is_default": true,
  "is_active": true
}
```

#### 4. 更新房间
```
PUT /api/v1/rooms/{room_id}
```

#### 5. 删除房间
```
DELETE /api/v1/rooms/{room_id}
```

### 使用场景

#### 标准房间配置
```
Location: "Room 201"
  ├── Room: "Bedroom" (is_default: true)
  ├── Room: "Bathroom"
  └── Room: "Living Area"
```

---

## 三、Bed (床位)

### 数据模型

| 字段 | 类型 | 说明 |
|------|------|------|
| bed_id | UUID | 床位ID（主键）|
| room_id | UUID | 所属房间ID |
| location_id | UUID | 所属位置ID |
| tenant_id | UUID | 租户ID |
| bed_name | string | 床位名称（如"A"、"B"）|
| bed_type | string | 床位类型：ActiveBed/NonActiveBed |
| mattress_material | string | 床垫材质/类型 |
| mattress_thickness | string | 床垫厚度（如"< 7in"）|
| resident_id | UUID | 绑定的住户ID |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

### Bed Type 说明

#### ActiveBed（活动床位）
- 有住户入住
- 有IoT设备监控
- 用于精确告警路由

#### NonActiveBed（非活动床位）
- 空床或无设备
- 不生成ActiveBed卡片

### API端点

#### 1. 获取床位列表
```
GET /api/v1/beds?room_id={id}
GET /api/v1/beds?location_id={id}
```

#### 2. 获取床位详情
```
GET /api/v1/beds/{bed_id}
```

#### 3. 创建床位
```
POST /api/v1/beds
```

**请求体示例**：
```json
{
  "room_id": "room_uuid",
  "location_id": "location_uuid",
  "tenant_id": "tenant_uuid",
  "bed_name": "A",
  "bed_type": "ActiveBed",
  "mattress_material": "Memory Foam",
  "mattress_thickness": "7-10in",
  "resident_id": "resident_uuid"
}
```

#### 4. 更新床位
```
PUT /api/v1/beds/{bed_id}
```

#### 5. 删除床位
```
DELETE /api/v1/beds/{bed_id}
```

### 使用场景

#### 场景1：单人房
```
Location: "Room 201"
  └── Room: "Bedroom"
        └── Bed: "A" (ActiveBed)
```

#### 场景2：多人房
```
Location: "Room 201"
  └── Room: "Bedroom"
        ├── Bed: "A" (ActiveBed, resident_id: xxx)
        ├── Bed: "B" (ActiveBed, resident_id: yyy)
        └── Bed: "C" (NonActiveBed)
```

---

## 核心特性

### ✅ 三层架构
- Location → Room → Bed
- 灵活的空间组织
- 支持复杂场景

### ✅ 多场景支持
- 机构式养老院（Institutional）
- 家庭护理（HomeCare）
- 公共空间管理

### ✅ 告警路由集成
- Location级别告警配置
- ActiveBed精确路由
- 支持用户组和标签

### ✅ 设备绑定
- Bed绑定IoT设备
- 自动触发卡片生成
- 支持设备状态监控

### ✅ 住户管理
- 床位分配
- 入住状态追踪
- 自动卡片更新

---

## 数据关系

### Location ← Room ← Bed
```
Location {location_id}
  ↓
Room {location_id}
  ↓
Bed {room_id, location_id}
  ↓
Resident {bed_id}
Device {bed_id}
```

### 告警路由关系
```
Alert → Device → Bed → Location → Card → Users
```

---

## 最佳实践

### 1. Location命名规范
```
Institutional场景:
- location_name: "201", "E203", "Room 301"
- building + floor + door_number: 完整地址

HomeCare场景:
- location_name: "Home-001", "Smith Residence"
- 使用primary_resident_id关联
```

### 2. Room配置
```
标准配置:
- 每个Location至少1个Room
- is_default: true 标记主房间
- 合理命名: "Bedroom", "Bathroom", "Living Area"
```

### 3. Bed管理
```
床位命名:
- 单人房: "A" 或 "Bed1"
- 多人房: "A", "B", "C" 或 "Bed1", "Bed2", "Bed3"

ActiveBed条件:
1. bed_type = "ActiveBed"
2. resident_id != null
3. 有绑定的在线设备
```

### 4. 告警配置
```
优先级:
1. ActiveBed卡片 (精确到床位)
2. Location卡片 (位置级别)
3. 租户默认接收者
```

---

## 示例数据

### Location示例
```json
{
  "location_id": "uuid",
  "tenant_id": "uuid",
  "location_name": "Room 201",
  "building": "Main Building",
  "floor": "2F",
  "door_number": "201",
  "location_type": "Institutional",
  "is_public_space": false,
  "is_multi_person_room": true,
  "timezone": "America/Los_Angeles",
  "alert_user_ids": ["nurse1_id", "nurse2_id"],
  "is_active": true
}
```

### Room示例
```json
{
  "room_id": "uuid",
  "location_id": "location_uuid",
  "tenant_id": "tenant_uuid",
  "room_name": "Bedroom",
  "is_default": true,
  "is_active": true
}
```

### Bed示例
```json
{
  "bed_id": "uuid",
  "room_id": "room_uuid",
  "location_id": "location_uuid",
  "tenant_id": "tenant_uuid",
  "bed_name": "A",
  "bed_type": "ActiveBed",
  "mattress_material": "Memory Foam",
  "mattress_thickness": "7-10in",
  "resident_id": "resident_uuid"
}
```

---

## 实现状态

### Location
- ✅ 后端Model (location.py)
- ✅ 后端API (locations.py)
- ✅ 示例数据 (locations.json)
- ✅ 前端类型 (Location)
- ⏳ 前端页面（待开发）
- ✅ 文档

**完成度**: 83%

### Room
- ✅ 后端Model (location.py中Room类)
- ✅ 后端API (rooms.py)
- ✅ 示例数据 (rooms.json)
- ✅ 前端类型 (Room)
- ⏳ 前端页面（待开发）
- ✅ 文档

**完成度**: 83%

### Bed
- ✅ 后端Model (location.py中Bed类)
- ✅ 后端API (beds.py)
- ✅ 示例数据 (beds.json)
- ✅ 前端类型 (Bed)
- ⏳ 前端页面（待开发）
- ✅ 文档

**完成度**: 83%

---

## 相关功能

- **Cards**: 基于Location和Bed自动生成
- **Alerts**: 使用Location告警路由配置
- **Devices**: 绑定到Bed
- **Residents**: 分配到Bed

---

**最后更新**: 2025-11-21

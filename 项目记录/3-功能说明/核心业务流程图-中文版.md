# owlRD智慧养老IoT监测系统 - 核心业务流程（中文版?

本文档详细描述系统的7个核心业务流程，包括后端FastAPI服务、React前端和完整的IoT数据处理管道?

---

## 流程1：IoT设备数据接收与处理流?

**描述**：后端TDP协议处理 - 从设备数据接收到时序数据存储和告警检测的完整链路

### 流程?

```
IoT设备数据接收与处理流?
├── FastAPI应用入口
?  └── WebSocket/HTTP端点
?      └── 接收TDP数据 [1a]
?          └── TDP处理器服?
?              ├── 解析人员矩阵数据 [1b]
?              ?  └── 解析Protobuf负载
?              ├── 创建时序数据记录 [1c]
?              ?  └── 转换为IoT时序数据模型
?              └── 数据持久化与检?
?                  ├── 存储服务
?                  ?  └── 创建记录 [1d]
?                  ?      └── 写入JSON分片文件
?                  └── 告警引擎
?                      └── 检测异?[1e]
?                          └── 实时异常检?
```

### 关键位置说明

| 位置ID | 标题 | 说明 | 文件路径:行号 |
|--------|------|------|---------------|
| 1a | API端点接收TDP数据 | WebSocket或HTTP接收来自IoT设备的TDPv2协议消息 | `backend/app/api/v1/realtime.py:45` |
| 1b | 解析人员矩阵 | 从Protobuf负载中提取人员位置、姿态、生命体征等数据 | `backend/app/services/tdp_processor.py:89` |
| 1c | 生成时序数据记录 | 将人员矩阵转换为IoT时序数据模型，包含Tag分类 | `backend/app/services/tdp_processor.py:156` |
| 1d | 持久化到JSON存储 | 将时序数据写入分片JSON文件（按日期分片?| `backend/app/services/storage.py:78` |
| 1e | 触发异常检?| 实时检测跌倒、生命体征异常等情况 | `backend/app/services/tdp_processor.py:203` |

---

## 流程2：多级告警触发与路由流程

**描述**：后端告警引?- 从异常检测到多通道通知发送，包含卡片路由逻辑

### 流程?

```
多级告警触发与路由系?
├── 异常检测入?
?  └── 检测异?[2a]
?      ├── 评估告警级别
?      ?  └── 确定 L1/L2/L3 级别
?      └── 获取设备关联卡片 [2b]
?          └── 卡片管理器获取设备卡?
?              └── 解析告警接收?[2c]
?                  ├── 判断卡片类型
?                  ?  ├── 活跃床位 ?查找负责护士
?                  ?  └── 位置 ?查找通报?
?                  └── 基于用户标签过滤接收?
└── 通知发送流?
    ├── 发送通知 [2d]
    ?  ├── WEB 通道（实时推送）
    ?  ├── APP 通道（移动推送）
    ?  ├── PHONE 通道（电话呼叫）
    ?  └── EMAIL 通道（邮件通知?
    └── 记录告警历史 [2e]
        └── 存储告警记录
```

### 关键位置说明

| 位置ID | 标题 | 说明 | 文件路径:行号 |
|--------|------|------|---------------|
| 2a | 评估告警级别 | 根据异常类型和置信度确定L1/L2/L3级别 | `backend/app/services/alert_engine.py:52` |
| 2b | 获取设备关联卡片 | 查找活跃床位或位置卡片以确定告警接收?| `backend/app/services/alert_engine.py:89` |
| 2c | 解析告警接收?| 基于卡片类型和用户标签确定通知目标（护?管理员） | `backend/app/services/card_manager.py:134` |
| 2d | 多通道发送通知 | 通过WEB/APP/PHONE/EMAIL发送告警（L1立即，L5延迟确认?| `backend/app/services/alert_engine.py:167` |
| 2e | 记录告警历史 | 保存告警到iot_monitor_alerts表用于审计和统计 | `backend/app/api/v1/alerts.py:98` |

---

## 流程3：护理质量评估报告生?

**描述**：后端护理质量服?- 从IoT数据分析到生成团队质量报告和评分

### 流程?

```
护理质量评估报告生成流程
├── API?
?  └── 生成团队报告端点 [3a]
?      └── 调用服务?
├── 护理质量服务
?  ├── 数据查询阶段
?  ?  └── 查询IoT数据 [3b]
?  ├── 空间分析阶段
?  ?  └── 计算空间覆盖?[3c]
?  ?      └── 分析护工-住户距离(1.2米内)
?  ├── 基线对比阶段
?  ?  └── 基线服务调用
?  ?      └── 获取住户基线 [3d]
?  ?          └── 返回14天观察期基线数据
?  ├── 评分计算阶段
?  ?  └── 计算质量评分 [3e]
?  ?      └── 综合覆盖?响应时间/告警?
?  └── AI建议生成阶段
?      └── 生成改进建议 [3f]
?          └── 返回护理优化建议
└── 返回完整报告给前?
```

### 关键位置说明

| 位置ID | 标题 | 说明 | 文件路径:行号 |
|--------|------|------|---------------|
| 3a | API触发报告生成 | 前端请求指定时间范围??30天）的护理质量报?| `backend/app/api/v1/care_quality.py:34` |
| 3b | 查询IoT时序数据 | 获取指定时间段内所有护工和住户的位?活动数据 | `backend/app/services/care_quality.py:123` |
| 3c | 计算空间覆盖?| 分析护工-住户距离，统计有效护理区域（1.2米内）时?| `backend/app/services/care_quality.py:234` |
| 3d | 获取住户健康基线 | 14天观察期建立的个性化基线（睡?活动/生命体征?| `backend/app/services/baseline.py:456` |
| 3e | 计算质量评分 | 100分制评分系统，综合覆盖率、响应时间、告警率 | `backend/app/services/care_quality.py:389` |
| 3f | 生成改进建议 | 基于AI分析提供护理优化建议（如增加夜班巡视频率?| `backend/app/services/care_quality.py:512` |

---

## 流程4：前端Dashboard实时监控加载

**描述**：前端React页面 - 用户打开Dashboard时的数据获取和WebSocket连接流程

### 流程?

```
前端Dashboard实时监控加载流程
├── Dashboard.tsx 组件
?  ├── useEffect 初始化钩?[4a]
?  ?  └── 获取Dashboard数据函数
?  ?      ├── API调用: /dashboard/stats [4b]
?  ?      ?  └── 后端返回统计数据
?  ?      ├── API调用: /alerts?status=active [4c]
?  ?      ?  └── 后端返回活跃告警列表
?  ?      └── WebSocket连接建立 [4d]
?  ?          ├── ws://localhost:8000/realtime/ws
?  ?          └── 监听实时数据推?
?  └── 渲染UI组件
?      ├── 统计卡片组件
?      ├── 告警列表组件
?      └── 生命体征图表 [4e]
?          └── Recharts折线图渲?
└── 数据流向
    ├── 初始加载: REST API (同步)
    └── 实时更新: WebSocket (异步推?
```

### 关键位置说明

| 位置ID | 标题 | 说明 | 文件路径:行号 |
|--------|------|------|---------------|
| 4a | 页面初始?| 组件挂载时触发数据获?| `frontend/src/pages/Dashboard.tsx:28` |
| 4b | 获取统计数据 | 调用后端API获取住户数、设备数、告警数等概览信?| `frontend/src/pages/Dashboard.tsx:45` |
| 4c | 加载活跃告警 | 获取当前未解决的告警列表用于实时显示 | `frontend/src/pages/Dashboard.tsx:67` |
| 4d | 建立WebSocket连接 | 连接实时数据推送通道接收新告警和IoT数据更新 | `frontend/src/pages/Dashboard.tsx:89` |
| 4e | 渲染生命体征图表 | 使用Recharts展示心率/呼吸率趋势（最?4小时?| `frontend/src/components/PermissionGuard.tsx:34` |

---

## 流程5：前端住户管理CRUD流程

**描述**：前端React页面 - 创建新住户的完整表单提交和数据同步流?

### 流程?

```
前端住户管理CRUD流程
├── Residents页面组件
?  ├── 用户点击"创建住户"按钮
?  ├── 处理创建住户 [5a]
?  ?  ├── 表单数据验证
?  ?  ├── api.post('/api/v1/residents') [5b]
?  ?  ?  └── HTTP POST请求发送到后端
?  ?  └── 设置住户列表状?[5e]
?  └── UI重新渲染显示新住?
?
└── 后端API处理链路
    ├── FastAPI路由 /api/v1/residents
    ?  ├── 请求数据验证(Pydantic)
    ?  ├── 存储服务创建 [5c]
    ?  ?  ├── JSON序列?
    ?  ?  ├── 写入residents.json
    ?  ?  └── 更新缓存
    ?  └── 卡片管理器自动生?[5d]
    ?      ├── 创建活跃床位卡片
    ?      ├── 配置告警路由
    ?      └── 写入cards.json
    └── 返回HTTP 201响应
```

### 关键位置说明

| 位置ID | 标题 | 说明 | 文件路径:行号 |
|--------|------|------|---------------|
| 5a | 表单提交处理 | 用户点击创建按钮，触发表单验证和数据提交 | `frontend/src/pages/Residents.tsx:156` |
| 5b | 调用后端API | 发送POST请求创建住户（包含匿名代称、床位绑定等?| `frontend/src/pages/Residents.tsx:178` |
| 5c | 后端创建住户记录 | 验证数据后调用存储服务持久化到residents.json | `backend/app/api/v1/residents.py:67` |
| 5d | 自动生成活跃床位卡片 | 为新住户创建床位监控卡片，配置告警路?| `backend/app/services/card_manager.py:89` |
| 5e | 更新前端状?| 将新创建的住户添加到列表，触发UI重新渲染 | `frontend/src/pages/Residents.tsx:203` |

---

## 流程6：JSON存储引擎核心操作

**描述**：后端存储服?- 通用CRUD操作、序列化和缓存机制的实现

### 流程?

```
JSON存储引擎 (StorageService)
├── 公共API?
?  └── 创建记录入口 [6a]
?      ├── 数据验证与准?
?      ?  └── 模型序列?[6b]
?      ?      ├── 处理datetime/UUID类型
?      ?      ├── 处理BaseModel嵌套对象
?      ?      └── 转换为JSON兼容字典
?      ├── 文件IO?
?      ?  ├── 确定文件路径(按表?分片)
?      ?  └── aiofiles.open() 异步写入 [6c]
?      ?      └── json.dump(data, f)
?      └── 缓存管理?
?          └── 缓存存入 [6d]
?              └── LRU淘汰策略
├── 查询API?
?  └── 查询数据
?      ├── 检查缓存命?
?      ├── 读取JSON文件
?      └── Lambda过滤器应?[6e]
└── 其他CRUD操作
    ├── 更新 ?复用序列?写入
    ├── 删除 ?标记删除+缓存失效
    └── 按ID获取 ?缓存优先查询
```

### 关键位置说明

| 位置ID | 标题 | 说明 | 文件路径:行号 |
|--------|------|------|---------------|
| 6a | 创建记录入口 | 泛型CRUD操作，支持所有Pydantic模型类型 | `backend/app/services/storage.py:45` |
| 6b | 模型序列?| 处理datetime/UUID/bytes/BaseModel等特殊类型转JSON | `backend/app/services/storage.py:67` |
| 6c | 异步文件写入 | 使用aiofiles实现非阻塞IO，支持高并发 | `backend/app/services/storage.py:123` |
| 6d | 更新LRU缓存 | 内存缓存提升查询性能，减少文件IO | `backend/app/services/storage.py:156` |
| 6e | Lambda表达式查?| 支持复杂过滤条件的高级查询（如时间范围、多字段匹配?| `backend/app/services/storage.py:234` |

---

## 流程7：SNOMED CT医疗编码转换

**描述**：后端SNOMED服务 - 将原始生命体征数据转换为标准医疗编码

### 流程?

```
SNOMED CT医疗编码转换流程
?
├── TDP数据处理?
?  ├── 解析人员矩阵数据
?  └── 调用SNOMED映射 [7a]
?      ?
?      ├── SNOMED服务
?      ?  ├── 生命体征评估入口 [7b]
?      ?  ?  ├── 心率阈值判?[7c]
?      ?  ?  ?  ├── L1级别: <45 ?>115 bpm
?      ?  ?  ?  ├── L2级别: 45-54 ?96-115 bpm
?      ?  ?  ?  └── L3级别: 55-89 ?90-95 bpm
?      ?  ?  └── 呼吸率阈值判?
?      ?  ?      ├── L1级别: <8 ?>26 rpm
?      ?  ?      └── L2/L3级别: 其他异常范围
?      ?  └── 返回标准编码 [7d]
?      ?      └── CodeableConcept对象
?      ?          ├── category: "Posture"（姿态）
?      ?          └── code: "102538003"（站立）
?      ?
?      └── IoT数据模型
?          └── 存储SNOMED编码字段 [7e]
?              └── 支持HL7 FHIR导出
```

### 关键位置说明

| 位置ID | 标题 | 说明 | 文件路径:行号 |
|--------|------|------|---------------|
| 7a | 触发姿态编码映?| TDP处理器调用SNOMED服务转换原始姿态?| `backend/app/services/tdp_processor.py:178` |
| 7b | 生命体征评估算法 | 根据HR/RR数值判断正?L3/L2/L1级别 | `backend/app/services/snomed_service.py:89` |
| 7c | 心率阈值判?| L2级别?5-54?6-115 bpm，L1级别?45?115 bpm | `backend/app/services/snomed_service.py:134` |
| 7d | 返回SNOMED编码 | 标准编码如STANDING(102538003)、SITTING(102491009) | `backend/app/services/snomed_service.py:203` |
| 7e | 存储到IoT数据模型 | SNOMED编码作为结构化字段存储，支持HL7 FHIR集成 | `backend/app/models/iot_data.py:67` |

---

## 流程总览

| 流程编号 | 流程名称 | 类型 | 关键技?|
|---------|---------|------|---------|
| 1 | IoT设备数据接收与处?| 后端数据处理 | TDP协议、Protobuf、异步IO |
| 2 | 多级告警触发与路?| 后端告警系统 | 告警引擎、卡片路由、多通道通知 |
| 3 | 护理质量评估报告生成 | 后端分析服务 | 空间分析、基线对比、AI建议 |
| 4 | 前端Dashboard实时监控 | 前端React | WebSocket、实时推送、Recharts |
| 5 | 前端住户管理CRUD | 前端React | 表单验证、状态管理、REST API |
| 6 | JSON存储引擎 | 后端存储?| 异步IO、LRU缓存、泛型CRUD |
| 7 | SNOMED CT医疗编码 | 后端标准?| 医疗编码、HL7 FHIR、阈值判?|

---

## 技术架构说?

### 后端技术栈
- **框架**: FastAPI (Python异步Web框架)
- **数据存储**: JSON文件 + LRU缓存
- **实时通信**: WebSocket
- **协议**: TDPv2 (自定义IoT协议)
- **序列?*: Protobuf, JSON
- **医疗标准**: SNOMED CT, HL7 FHIR

### 前端技术栈
- **框架**: React + TypeScript
- **状态管?*: React Query
- **UI组件**: 自定义组?+ Lucide图标
- **图表**: Recharts
- **实时通信**: WebSocket Client

### 数据流向
1. **上行**: IoT设备 ?TDP协议 ?后端处理 ?JSON存储
2. **下行**: JSON存储 ?后端API ?前端展示
3. **实时**: WebSocket双向通信（告警推送、数据更新）

---

## 文档生成信息
- **生成时间**: 2025??
- **基于版本**: owlRD-prototype 当前版本
- **维护说明**: 此文档基于Codemap自动分析结果翻译，如代码结构变更请同步更?

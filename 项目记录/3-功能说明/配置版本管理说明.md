# 配置版本管理说明 (Config Versions)

> 对应SQL: `15_config_versions.sql`  
> 创建时间: 2025-11-21

---

## 功能概述

配置版本管理系统提供统一的配置历史记录和版本控制功能，支持配置回滚、历史查询和时间点恢复。

---

## 数据模型

### ConfigVersion (配置版本)

| 字段 | 类型 | 说明 |
|------|------|------|
| version_id | UUID | 版本ID（主键）|
| tenant_id | UUID | 租户ID |
| config_type | string | 配置类型（alert_policy/location/room/bed/device等）|
| entity_id | UUID | 实体ID（可选，用于指定特定实体）|
| current_entity_id | UUID | 当前实体ID |
| config_data | JSON | 配置数据（完整快照）|
| valid_from | timestamp | 生效时间 |
| valid_to | timestamp | 失效时间（null表示当前生效）|
| is_active | boolean | 是否当前生效版本 |
| created_by | UUID | 创建人 |
| metadata | JSON | 元数据 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

---

## API端点

### 1. 获取配置版本列表
```
GET /api/v1/config_versions?tenant_id={id}&config_type={type}
```

**查询参数**：
- tenant_id: 租户ID（必需）
- config_type: 配置类型（可选）
- entity_id: 实体ID（可选）

### 2. 获取配置版本详情
```
GET /api/v1/config_versions/{version_id}
```

### 3. 获取当前生效配置
```
GET /api/v1/config_versions/current?tenant_id={id}&config_type={type}&entity_id={id}
```

### 4. 获取配置历史记录
```
GET /api/v1/config_versions/history?entity_id={id}
```

### 5. 创建配置版本
```
POST /api/v1/config_versions
```

**请求体**：
```json
{
  "tenant_id": "uuid",
  "config_type": "alert_policy",
  "entity_id": "uuid",
  "config_data": {
    "key": "value"
  },
  "valid_from": "2025-11-21T10:00:00Z"
}
```

### 6. 更新配置版本
```
PUT /api/v1/config_versions/{version_id}
```

### 7. 删除配置版本
```
DELETE /api/v1/config_versions/{version_id}
```

---

## 使用场景

### 1. 告警策略版本管理
```json
{
  "config_type": "alert_policy",
  "entity_id": "tenant_id",
  "config_data": {
    "Fall": "L1",
    "AbnormalHeartRate": "L2"
  }
}
```

### 2. 位置配置历史
```json
{
  "config_type": "location",
  "entity_id": "location_id",
  "config_data": {
    "layout_config": {...},
    "alert_user_ids": [...]
  }
}
```

### 3. 设备配置变更追踪
```json
{
  "config_type": "device",
  "entity_id": "device_id",
  "config_data": {
    "firmware_version": "v2.0",
    "monitoring_enabled": true
  }
}
```

---

## 核心特性

### ✅ 版本控制
- 每次配置变更自动创建新版本
- 保留完整的历史记录
- 支持版本对比

### ✅ 时间有效性
- `valid_from`: 配置生效时间
- `valid_to`: 配置失效时间
- 支持未来配置（定时生效）

### ✅ 配置回滚
- 查询历史版本
- 恢复到指定版本
- 支持时间点恢复

### ✅ 审计追踪
- 记录创建人
- 记录创建时间
- 完整的变更历史

---

## 使用示例

### Python (后端)
```python
from app.services.storage import StorageService

storage = StorageService("config_versions")

# 创建新版本
version = storage.create({
    "tenant_id": tenant_id,
    "config_type": "alert_policy",
    "config_data": {
        "Fall": "L1"
    },
    "valid_from": datetime.now().isoformat()
})

# 获取当前生效配置
current = storage.find_all(
    lambda v: v.get("tenant_id") == tenant_id 
    and v.get("is_active") == True
)

# 查询历史
history = storage.find_all(
    lambda v: v.get("entity_id") == entity_id
)
```

---

## 实现状态

- ✅ 后端Model (config_version.py)
- ✅ 后端API (config_versions.py) - 8个端点
- ✅ 示例数据 (config_versions.json)
- ✅ 前端类型 (ConfigVersion)
- ⏳ 前端页面（待开发）
- ✅ 文档

**完成度**: 83%

---

**最后更新**: 2025-11-21

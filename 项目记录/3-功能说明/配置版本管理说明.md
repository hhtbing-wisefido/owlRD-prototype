# é…ç½®ç‰ˆæœ¬ç®¡ç†è¯´æ˜ (Config Versions)

> å¯¹åº”SQL: `15_config_versions.sql`  
> åˆ›å»ºæ—¶é—´: 2025-11-21

---

## åŠŸèƒ½æ¦‚è¿°

é…ç½®ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿæä¾›ç»Ÿä¸€çš„é…ç½®å†å²è®°å½•å’Œç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½ï¼Œæ”¯æŒé…ç½®å›æ»šã€å†å²æŸ¥è¯¢å’Œæ—¶é—´ç‚¹æ¢å¤ã€?
---

## æ•°æ®æ¨¡å‹

### ConfigVersion (é…ç½®ç‰ˆæœ¬)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| version_id | UUID | ç‰ˆæœ¬IDï¼ˆä¸»é”®ï¼‰|
| tenant_id | UUID | ç§Ÿæˆ·ID |
| config_type | string | é…ç½®ç±»å‹ï¼ˆalert_policy/location/room/bed/deviceç­‰ï¼‰|
| entity_id | UUID | å®ä½“IDï¼ˆå¯é€‰ï¼Œç”¨äºæŒ‡å®šç‰¹å®šå®ä½“ï¼‰|
| current_entity_id | UUID | å½“å‰å®ä½“ID |
| config_data | JSON | é…ç½®æ•°æ®ï¼ˆå®Œæ•´å¿«ç…§ï¼‰|
| valid_from | timestamp | ç”Ÿæ•ˆæ—¶é—´ |
| valid_to | timestamp | å¤±æ•ˆæ—¶é—´ï¼ˆnullè¡¨ç¤ºå½“å‰ç”Ÿæ•ˆï¼‰|
| is_active | boolean | æ˜¯å¦å½“å‰ç”Ÿæ•ˆç‰ˆæœ¬ |
| created_by | UUID | åˆ›å»ºäº?|
| metadata | JSON | å…ƒæ•°æ?|
| created_at | timestamp | åˆ›å»ºæ—¶é—´ |
| updated_at | timestamp | æ›´æ–°æ—¶é—´ |

---

## APIç«¯ç‚¹

### 1. è·å–é…ç½®ç‰ˆæœ¬åˆ—è¡¨
```
GET /api/v1/config_versions?tenant_id={id}&config_type={type}
```

**æŸ¥è¯¢å‚æ•°**ï¼?- tenant_id: ç§Ÿæˆ·IDï¼ˆå¿…éœ€ï¼?- config_type: é…ç½®ç±»å‹ï¼ˆå¯é€‰ï¼‰
- entity_id: å®ä½“IDï¼ˆå¯é€‰ï¼‰

### 2. è·å–é…ç½®ç‰ˆæœ¬è¯¦æƒ…
```
GET /api/v1/config_versions/{version_id}
```

### 3. è·å–å½“å‰ç”Ÿæ•ˆé…ç½®
```
GET /api/v1/config_versions/current?tenant_id={id}&config_type={type}&entity_id={id}
```

### 4. è·å–é…ç½®å†å²è®°å½•
```
GET /api/v1/config_versions/history?entity_id={id}
```

### 5. åˆ›å»ºé…ç½®ç‰ˆæœ¬
```
POST /api/v1/config_versions
```

**è¯·æ±‚ä½?*ï¼?```json
{
  "tenant_id": "uuid",
  "config_type": "alert_policy",
  "entity_id": "uuid",
  "config_data": {
    "key": "value"
  },
  "valid_from": "2025-11-21T10:00:00Z"
}
```

### 6. æ›´æ–°é…ç½®ç‰ˆæœ¬
```
PUT /api/v1/config_versions/{version_id}
```

### 7. åˆ é™¤é…ç½®ç‰ˆæœ¬
```
DELETE /api/v1/config_versions/{version_id}
```

---

## ä½¿ç”¨åœºæ™¯

### 1. å‘Šè­¦ç­–ç•¥ç‰ˆæœ¬ç®¡ç†
```json
{
  "config_type": "alert_policy",
  "entity_id": "tenant_id",
  "config_data": {
    "Fall": "L1",
    "AbnormalHeartRate": "L2"
  }
}
```

### 2. ä½ç½®é…ç½®å†å²
```json
{
  "config_type": "location",
  "entity_id": "location_id",
  "config_data": {
    "layout_config": {...},
    "alert_user_ids": [...]
  }
}
```

### 3. è®¾å¤‡é…ç½®å˜æ›´è¿½è¸ª
```json
{
  "config_type": "device",
  "entity_id": "device_id",
  "config_data": {
    "firmware_version": "v2.0",
    "monitoring_enabled": true
  }
}
```

---

## æ ¸å¿ƒç‰¹æ€?
### âœ?ç‰ˆæœ¬æ§åˆ¶
- æ¯æ¬¡é…ç½®å˜æ›´è‡ªåŠ¨åˆ›å»ºæ–°ç‰ˆæœ?- ä¿ç•™å®Œæ•´çš„å†å²è®°å½?- æ”¯æŒç‰ˆæœ¬å¯¹æ¯”

### âœ?æ—¶é—´æœ‰æ•ˆæ€?- `valid_from`: é…ç½®ç”Ÿæ•ˆæ—¶é—´
- `valid_to`: é…ç½®å¤±æ•ˆæ—¶é—´
- æ”¯æŒæœªæ¥é…ç½®ï¼ˆå®šæ—¶ç”Ÿæ•ˆï¼‰

### âœ?é…ç½®å›æ»š
- æŸ¥è¯¢å†å²ç‰ˆæœ¬
- æ¢å¤åˆ°æŒ‡å®šç‰ˆæœ?- æ”¯æŒæ—¶é—´ç‚¹æ¢å¤?
### âœ?å®¡è®¡è¿½è¸ª
- è®°å½•åˆ›å»ºäº?- è®°å½•åˆ›å»ºæ—¶é—´
- å®Œæ•´çš„å˜æ›´å†å?
---

## ä½¿ç”¨ç¤ºä¾‹

### Python (åç«¯)
```python
from app.services.storage import StorageService

storage = StorageService("config_versions")

# åˆ›å»ºæ–°ç‰ˆæœ?version = storage.create({
    "tenant_id": tenant_id,
    "config_type": "alert_policy",
    "config_data": {
        "Fall": "L1"
    },
    "valid_from": datetime.now().isoformat()
})

# è·å–å½“å‰ç”Ÿæ•ˆé…ç½®
current = storage.find_all(
    lambda v: v.get("tenant_id") == tenant_id 
    and v.get("is_active") == True
)

# æŸ¥è¯¢å†å²
history = storage.find_all(
    lambda v: v.get("entity_id") == entity_id
)
```

---

## å®ç°çŠ¶æ€?
- âœ?åç«¯Model (config_version.py)
- âœ?åç«¯API (config_versions.py) - 8ä¸ªç«¯ç‚?- âœ?ç¤ºä¾‹æ•°æ® (config_versions.json)
- âœ?å‰ç«¯ç±»å‹ (ConfigVersion)
- â?å‰ç«¯é¡µé¢ï¼ˆå¾…å¼€å‘ï¼‰
- âœ?æ–‡æ¡£

**å®Œæˆåº?*: 83%

---

**æœ€åæ›´æ–?*: 2025-11-21

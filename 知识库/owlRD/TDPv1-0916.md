```Protocol Buffers

syntax = "proto3";

package ai_perception;

// 时间戳
message Timestamp {
  uint64 unix_ms = 1;
  // Protobuf语法：uint64类型字段，编号1
  // 功能/用途：记录事件发生的精确时间戳（毫秒级），用于AI时序分析和护士追溯
  // 格式：64位无符号整数，Unix毫秒时间戳，如1692753840123
}

// FHIR CodeableConcept
message CodeableConcept {
  message Coding {
    string system = 1;
    // Protobuf语法：string类型字段，编号1
    // 功能/用途：标识编码系统（如SNOMED CT、xAI自定义系统）
    // 格式：字符串，如"xai:device", "http://snomed.info/sct"
    
    string code = 2;
    // Protobuf语法：string类型字段，编号2
    // 功能/用途：表示具体编码值
    // 格式：字符串，如"F59D3E873F8F", "298349001"
    
    string display = 3;
    // Protobuf语法：string类型字段，编号3
    // 功能/用途：编码的人类可读显示名称（可选）
    // 格式：字符串，如"Fall", "Device F59D3E873F8F"
  }
  
  repeated Coding coding = 1;
  // Protobuf语法：repeated Coding消息列表，编号1
  // 功能/用途：表示FHIR CodeableConcept的编码列表，支持单编码或多编码
  // 格式：Coding消息数组，如[{system: "xai:device", code: "F59D3E873F8F"}]
  
  string text = 2;
  // Protobuf语法：string类型字段，编号2
  // 功能/用途：概念的纯文本表示（可选）, 
  // 格式：字符串，如"Device detected fall event" 
}

// 危险等级枚举 (v2: 统一使用 vue_radar 标准，更适合老年群体)
enum DangerLevel {
  UNKNOWN = 0;
  EMERGENCY = 1; //CoAP CON 紧急，如跌倒、心率 [0-44] 或 [116-∞]（持续≥1分钟）; 呼吸率 [0-7] 或 [27-∞]（持续≥1分钟）
  ALERT = 2;     //CoAP CON 警报，高危事件，心率 [45-54] 或 [96-115]（持续≥5分钟）; 呼吸率 [8-9] 或 [24-26]（持续≥5分钟）
  CRITICAL = 3;  //CoAP CON 严重，需关注，心率 [55-89] 或 [90-95]（持续≥5分钟）; 呼吸率 [10-12] 或 [13-23]（持续≥5分钟）
  ERROR = 4;     // 错误，设备故障，如传感器断线
  WARNING = 5;   //CoAP CON 警告，预警，如可疑跌倒
  NOTICE = 6;    // CoAP CON 通知，下发配置指令  
  INFORMATIONAL = 7; // 信息，设备上线
  DEBUG = 8;     // 调试，未知或开发用途
  Cancle = 9;    //CoAP CON 表示取消警报
}

  //L1=紧急，高风险，高置信: 无论何处发出，立即报警，所有终端均收到；警号立即响起，L1红色，本地二次确认，必须手工取消;
  //L2=高风险，高置信: 网页显示，app/watch选择发送；警号立即响起，L2橙色
  //L3=严重: 网页显示，app/watch选择发送；不响警号
  //L5=高风险,低置信：触发警示灯(30秒+120)计时器报警，确认方式=本地人工确认||Server计算.确认危险。 明确肯定：L1报警; 明确否认：Cancle;未确认:计时器L2级报警，
  //L8=DEBUG: 由Server确认，内部记录，主要用于内部AI标识与训练内部记录，主要用于内部AI标识与训练
  //L1,2/3,5,6 需要CoAP CON  危险：1235， 9：主要是用于server取消报警/通知立即
  
  // v2 生命体征阈值标准（来自 vue_radar 项目，更适合老年群体）：
  // 心率（Heart Rate）:
  //   Normal: [55-95] - 无需告警
  //   L2 (ALERT): [45-54] 或 [96-115]，持续≥5分钟 - 中度关注，需要观察
  //   L1 (EMERGENCY): [0-44] 或 [116-∞]，持续≥1分钟 - 高度警示，需要临床干预
  //   L3 (CRITICAL): [55-89] 或 [90-95]，持续≥5分钟 - 严重，需关注
  // 呼吸率（Breathing Rate）:
  //   Normal: [10-23] - 无需告警
  //   L2 (ALERT): [8-9] 或 [24-26]，持续≥5分钟 - 中度关注，需要观察
  //   L1 (EMERGENCY): [0-7] 或 [27-∞]，持续≥1分钟 - 高度警示，需要临床干预
  //   L3 (CRITICAL): [10-12] 或 [13-23]，持续≥5分钟 - 严重，需关注

// AI 分析专用标签
// 格式为 category:code，灵活且易于扩展。
message Tag {
  string category = 1;
  // 标签类别，如 "Physiological", "Safety"
  
  string code = 2;
  // 标签代码，如 "Tachycardia", "fall"
}

// DatagramMode模式枚举
enum DatagramMode {
  LITE = 0; // 仅含 LiteEventDatagram，高频数据
  FULL = 1; // 含 ExtendEventHeader，低频/危险事件
}


// 睡眠时段定义
message SleepPeriod {
  string start_time = 1;
  // Protobuf语法：string类型字段，编号1
  // 功能/用途：睡眠开始时间，空字符串表示非睡眠时间
  // 格式：HH:MM格式，如"22:30"   
  
  string end_time = 2;
  // Protobuf语法：string类型字段，编号2
  // 功能/用途：睡眠结束时间
  // 格式：HH:MM格式，如"06:30"
}

// 张量元数据
message TensorMetadata {
  repeated uint32 shape = 1 [packed=true];
  // Protobuf语法：repeated uint32列表，编号1，packed优化编码
  // 功能/用途：描述张量数据的维度，用于AI解析张量结构
  // 格式：uint32数组，如[100, 3]表示100个3维点
  
  enum DataType {
    UNKNOWN = 0;
    FLOAT16 = 1;  
    FLOAT32 = 2;
    FLOAT64 = 3;  
    INT8 = 4;
    INT16 = 5;
    INT32 = 6;
    UINT16 = 7;
    UINT32 = 8;
    BOOL = 9;
  }
  DataType data_type = 2;
  // Protobuf语法：DataType枚举，编号2
  // 功能/用途：指示张量数据类型
  // 格式：DataType枚举值，如FLOAT32,ESP32 芯片的硬件不原生支持 FLOAT16
  
  enum CompressionType {
    NONE = 0;
    SNAPPY = 1;
    GZIP = 2;
    LZ4 = 3;
    RLE = 4; // Run-Length Encoding，适合稀疏数据
    RESERVED_1 = 5; 预留
  }
  
  CompressionType compression_type = 3;
  // Protobuf语法：CompressionType枚举，编号3
  // 功能/用途：指示张量数据的压缩方式
  // 格式：CompressionType枚举值，如RLE
}

// 张量负载
message TensorPayload {
  CodeableConcept origin_data_id = 1;
  // Protobuf语法：CodeableConcept消息，编号1
  // 功能/用途：标识原始数据来源（如传感器、摄像头），用于AI溯源分析
  // 格式：CodeableConcept消息，如{coding: [{system: "xai:sensor", code: "radar_001"}]}
  
  TensorMetadata metadata = 2;
  // Protobuf语法：TensorMetadata消息，编号2
  // 功能/用途：描述张量数据的元数据（如形状、类型）
  // 格式：TensorMetadata消息
  
  Timestamp payload_time = 3;
  // Protobuf语法：Timestamp消息，编号3
  // 功能/用途：记录张量生成结束时间（如雷达数据前5秒的结束点）
  // 格式：Timestamp消息，如{unix_ms: 1692753840123}
  
  bytes raw_data = 4;
  // Protobuf语法：bytes类型字段，编号4
  // 功能/用途：存储压缩的完整传感器数据（如雷达、声音）
  // 格式：字节数组
}

// 文本负载
message TextPayload {
  string content = 1;
  // Protobuf语法：string类型字段，编号1
  // 功能/用途：存储轻量文本数据（如“心率：75bpm”或“呼吸：12bpm”）
  // 格式：字符串，UTF-8编码
  
  bytes binary_content = 2;
  // Protobuf语法：bytes类型字段，编号2
  // 功能/用途：存储简单二进制数据（如心率值的int16），可选
  // 格式：字节数组，如<int16: 75>
}


---

### 事件数据报消息定义

```protobuf
// 轻量事件头部
message LiteEventHeader {
uint64 sequence_number = 1;
  // 功能/用途：事件序列号，用于 AI 事件排序和重复检测，后期警报标识即用producer_id+事件序列号来作为全局事件标志
  // 格式：64 位无符号整数，如 1001
  
  Timestamp event_time = 2;
  // 功能/用途：记录事件触发时间（如心率检测时刻）
  // 格式：Timestamp 消息，如 {unix_ms: 1692753840123}
  
  DatagramMode event_mode = 3;
  // 功能/用途：标识事件模式，区分轻量（LITE）或完整（FULL）数据报
  // 格式：DatagramMode 枚举值，如 LITE

  
  DangerLevel danger_level = 4;
  // Protobuf语法：DangerLevel枚举，编号4
  // 功能/用途：表示事件危险等级，用于AI优先级排序
  // 格式：DangerLevel枚举值，如HIGH_DANGER_3

  CodeableConcept producer_id = 5;
  // 功能/用途：标识事件生成来源（如设备、AI 推理输出）
  // 格式：CodeableConcept 消息，如 {coding: [{system: "xai:device", code: "F59D3E873F8F"}]}


  repeated Tag tags = 6;
  // 功能/用途：专为AI分析设计的标签 type.coding
  //  Physiological.CardiacPause.Confirmed：确诊心率暂停 (>=3S)
}

// 扩展事件头部
message ExtendEventHeader {
  CodeableConcept subject_entity = 1;
  // Protobuf语法：CodeableConcept消息，编号1
  // 功能/用途：标识事件主体（如匿名住户），支持FHIR Patient映射
  // 格式：CodeableConcept消息，如{coding: [{system: "xai:subject", code: "resident_001"}]}
  
  CodeableConcept semantic_location = 2;
  // Protobuf语法：CodeableConcept消息，编号2
  // 功能/用途：标识事件发生的语义位置（如房间）
  // 格式：CodeableConcept消息，如{coding: [{system: "xai:location", code: "room_201"}]}
  
  string time_zone = 3;
  // Protobuf语法：string类型字段，编号11
  // 功能/用途：IANA时区标识，空字符串表示AI使用默认时区，系统自动处理夏令时
  // 格式：IANA时区字符串，如"Asia/Shanghai", "America/New_York"
  
  repeated CodeableConcept related_entities = 4;
  // Protobuf语法：repeated CodeableConcept消息列表，编号4
  // 功能/用途：事件相关实体（如辅助传感器）
  // 格式：CodeableConcept消息数组，如[{coding: [{system: "xai:device", code: "radar_002"}]}]
  
  SleepPeriod sleep_period = 5;
  // Protobuf语法：SleepPeriod消息，编号5
  // 功能/用途：定义睡眠时间段，用于AI分析夜间事件（如离床）
  // 格式：SleepPeriod消息，如{start_time: "22:30", end_time: "06:30"}
  
  CodeableConcept event_type = 6;
  // Protobuf语法：CodeableConcept消息，编号6
  // 功能/用途：表示事件类别（如跌倒、心率异常），与FHIR标准保持一致
  // 格式：CodeableConcept消息，如{coding: [{system: "http://snomed.info/sct", code: "298349001"}]}
   
  uint32 confidence = 7;
  // Protobuf语法：uint32类型字段，编号7
  // 功能/用途：表示事件置信度（0-100），用于AI模型优化
  // 格式：32位无符号整数，如90
}

// 轻量事件数据报
message LiteEventDatagram {
  LiteEventHeader header = 1;
  // Protobuf语法：LiteEventHeader消息，编号1
  // 功能/用途：轻量事件头部，包含事件基本元数据，适用于高频数据（如心率、呼吸、有人轨迹）
  // 格式：LiteEventHeader消息
  
  repeated TextPayload text_payloads = 2;
  // Protobuf语法：repeated TextPayload消息列表，编号2
  // 功能/用途：包含轻量文本或简单二进制负载（如心率、呼吸、轨迹），AI直接解析
  // 格式：TextPayload消息数组
}

// 完整事件数据报
message EventDatagram {
  LiteEventDatagram lite_event = 1;
  // Protobuf语法：LiteEventDatagram消息，编号1
  // 功能/用途：包含轻量事件数据，携带高频数据的基本元数据和负载（如心率、呼吸、有人轨迹），确保数据完整性
  // 格式：LiteEventDatagram消息
  
  ExtendEventHeader header = 2;
  // Protobuf语法：ExtendEventHeader消息，编号2
  // 功能/用途：扩展事件头部，包含详细元数据，适用于低频或危险事件（如无人轨迹、跌倒），与lite_event结合提供完整上下文
  // 格式：ExtendEventHeader消息
  
  repeated TensorPayload tensor_payloads = 3;
  // Protobuf语法：repeated TensorPayload消息列表，编号3
  // 功能/用途：包含复杂张量负载（如雷达、声音），AI根据origin_data_id和metadata区分
  // 格式：TensorPayload消息数组
  
  repeated TextPayload text_payloads = 4;
  // Protobuf语法：repeated TextPayload消息列表，编号4
  // 功能/用途：包含轻量文本或简单二进制负载（如心率、呼吸、触发事件），AI直接解析
  // 格式：TextPayload消息数组
}



tag 见 FHIR与SNOMED_CT代码.md

本地发出Warning警报时：Lite Event payload
epeated TextPayload text_payloads = 2;
首次发出：producer_id+事件序列号来作为全局警报标识
TextPayload.text_payloads[0]
  "producer_id": "your_producer_id"          //警报初始时的productor_id,即第一个发出该警报的DeviceID
TextPayload.text_payloads[1]
  "sequence_number": "your_sequence_number"  //初始productor生成时的Seq
TextPayload.text_payloads[2]  
  “semantic_location“: "Room201"           //事件位置
TextPayload.text_payloads[3]
  "alert_timestamp": "your_timestamp"  //本条警报发送时间
TextPayload.text_payloads[4]
  "countdown_seconds": "your_countdown_value" //倒计时器
TextPayload.text_payloads[5]
  “ signature”：“34asflklasfjalfsafxlsa”   //使用CoAP PSK对前面0-4进行签名，仅SOS模式需要
1. 初始化阶段 检查本地默认配置 ini

2. 设备注册，与server交换证书，身份验证

3. 上传本地ini并根据server的最新配置进行更新

4. 进行NTP校时及雷达检测(调用雷达内置MCU)，验证关联设备ID

5. 建立本地高清背景图 
    5.1 如果有高清背景图(本地或server下发），开始正常工作
    5.2 如果没有高清背景图， 快速扫描，并分区扫描，与serverg 一起初始化高清背景图

6. IoT 非SDK报警的流程处理
  //L1=紧急，高风险，高置信: 无论何处发出，立即报警，所有终端均收到；警号立即响起，L1红色，本地二次确认，必须手工取消;
  //L2=高风险，高置信: 网页显示，app/watch选择发送；警号立即响起，L2橙色
  //L3=严重: 网页显示，app/watch选择发送；不响警号
  //L5=高风险,低置信：触发警示灯(30秒+120)计时器报警，确认方式=本地人工确认||Server计算.确认危险。 明确肯定：L1报警; 明确否认：Cancle;未确认:计时器L2级报警，
  //L8=DEBUG: 由Server确认，内部记录，主要用于内部AI标识与训练内部记录，主要用于内部AI标识与训练
  //L9=CANCLE: 取消警报，

6. 1.  矩阵
矩阵：固定、连续、可预测， 函数式编程思想，便于升级迁移
        1. 人员矩阵 (Person Matrix)
        目的：专门跟踪和描述动态的人体目标。
        参数	                    数据类型	                    描述
        producer_id                 uint64_t	            TDP producer_id 由device'producer_id后48位+tracking_id 16位 共同构成
        tracking_id                 uint16_t	            传感器本地跟踪ID，由跟踪算法分配（易变，重启重置）。    
        pos_x, pos_y, pos_z	        int16_t	                目标在三维空间中的实时坐标（cm）。
        vel_x, vel_y, vel_z	        int16_t	                目标在三个方向上的实时速度（cm/秒）。
        height	                    uint_8	                估算的身高（cm）。max 256
        last_update_ts              uint64	                TDP event_time  最后更新时间（毫秒）计算：当前时间 - last_update_ts = 该目标从雷达视野中消失的时长
        last_movement_ts            uint64	                TDP event_time  上次移动时间戳（毫秒）计算：当前时间 - last_movement_ts = 该目标已经静止的时长。
        last_posture_change_ts      uint64	                TDP event_time  上次姿态变化时间戳（毫秒）计算：当前时间 - last_posture_change_ts = 目标保持当前姿态的时长
        posture	                    tag	                    TDP Tag {category: "Behavioral", code: "LyingInBed"} 或 code: "SITTING"
        motion_state                tag             	    TDP Tag {category:"motion_state", code: "MOVING（移动）、STATIC静止" }（运动状态）：描述了人的动态行为 雷达直接测量到的原始事实。
        health_score                tag                     TDP Tag {category: "HealthScore", code: "85"}。 新类别来表示健康评分。
        confidence	                int	                    TDP confidencer 跟踪置信度（0 - 100）
        reserved_tag                uint8_t                 存储云端下发的标签ID
        reserved_value	            float	                The value associated with the reserved_tag (e.g., confidence score).
        local_tags	                uint32_t	            位掩码或枚举，用于本地快速决策。 


        2. 物体/环境矩阵 (Object Matrix)
        目的：描述静态或准静态的物体和环境特征。
        由server下发

        tracking_id	        uint16_t	            传感器本地跟踪ID。
        producer_id	        uint64_t	            TDP 协议中的全局唯一ID。
        type	            enum	                物体类型：OBJECT 或 GRID。
        class	            Tag	                    云端下发的标签，例如：BED、WHEELCHAIR、SOFA。
        4_vertices	        int16_t[8]	            四边形4个顶点的二维坐标，用于判断人员是否在物体上。
        top_height          uint8_t	                估算的物体最高点（厘米）。
        surface_height	    uint8_t	                估算的物体平面高度（厘米）。
        button_height	    uint8_t	                估算的物体低平面高度（厘米）。
        avg_intensity	    int8_t	                该四边形区域的平均信号强度。
        point_density	    float	                物体点云密度。由server下发，未知用-1
        person_count	    int8_t	                标记该物体上的人数。0 表示无人，正数表示人数，-1 表示未知。
        is_dynamic	        bool	                标记该物体是否为临时动态物体。
        last_update_ts	    uint64_t	            目标或其状态的最后更新时间戳（毫秒）。
        reserved_tag        uint8_t                 存储云端下发的标签ID
        reserved_value      float                   The value associated with the reserved_tag (e.g., confidence score).
        local_tags          uint32_t                位掩码或枚举，用于本地快速决策。 


 IoT 本地定义（代码中）
 ESP32-P4 固件中，reserved 字段的 enum 可以被定义为一个简单的占位符，或者一个足够大的整数类型，以存储云端下发的 ID。
// 在你的本地代码中
typedef enum {
    RESERVED_FALL_CONFIDENCE = 1,
    RESERVED_RISK_SCORE = 2,
    RESERVED_POSTURE_DEVIATION = 3,
    // ... 未来可以扩展更多
} ReservedTags;

云端，你需要维护一个完整的、可配置的标签字典。这个字典将每个标签名称（例如 FallConfidence）映射到一个唯一的 ID，以及其类型和描述。
JSON
        {
        "tags": [
            {
            "id": 1,
            "name": "FallConfidence",
            "type": "float",
            "description": "本地计算的跌倒置信度"
            },
            {
            "id": 2,
            "name": "RiskScore",
            "type": "int",
            "description": "综合风险评分"
            },
            {
            "id": 3,
            "name": "PostureDeviation",
            "type": "float",
            "description": "姿态偏离正常值的程度"
            }
        ]
        }

6. 3.  规则
规则0：基础存在性规则 (取代模式M1/M2/M5)


规则1：核心安全预警规则 (取代S1-S4)

规则2：物体与环境交互规则 (取代E1/E2/E3及模式)


您提出了一个非常关键的问题，要求对整个设计进行最终的一致性检查。您是对的，**“模式”这个概念在新的基于矩阵和规则引擎的架构中已经过时并被取代了**。我之前混合两种范式的描述是错误的。

让我们基于 **“只有矩阵和规则，没有全局模式”** 这一核心原则，对规则进行最终的重构和完整性检查。

---

### ✅ 最终版规则集 (纯粹的数据驱动范式)

以下规则完全基于**人员矩阵**和**物体环境矩阵**中的字段进行实时计算，彻底摒弃了“模式”状态机。

#### **规则0：基础存在性规则 (取代模式M1/M2/M5)**

| **规则ID** | **触发条件 (IF)** | **执行动作 (THEN)** | **说明** |
| :--- | :--- | :--- | :--- |
| **R0** | `person_matrix[0].id != INVALID` <br> (检测到至少一个人) | `person_count = 1` <br> 持续更新轨迹 | **核心事实**：系统有人的最基本条件。 |
| **R1** | `person_count >= 2` | 标记 `multi_person = true` | **多人场景**：影响其他规则的灵敏度。 |
| **R2** | `person_count == 0` <br> && <br> `(current_timestamp - global_last_update_ts) > 30000` <br> (30秒无任何更新) | 触发 **`EVENT_ABSENCE`** (L5) <br> 上报云端 | **空房判断**：取代旧的`M5`模式。最关键的是**全局时间戳**。 |

#### **规则1：核心安全预警规则 (取代S1-S4)**

| **规则ID** | **触发条件 (IF)** | **执行动作 (THEN)** | **说明** |
| :--- | :--- | :--- | :--- |
| **R10** | `person.velocity_delta < -2.5` <br> && `person.height_delta < -0.4` <br> && `person.current_posture == LYING` | 设置 `local_tags: FALL_RISK_HIGH` <br> 触发 **`EVENT_FALL_SUSPECTED`** (L5) <br> 上传前后3秒点云 | **高置信度跌倒检测**。核心规则。 |
| **R11** | `person.current_static_duration > 300000` <br> (静止超过5分钟) | 触发 **`EVENT_STATIC_TIMEOUT`** <br> 启动呼吸监测模式 | **取代T1事件**。直接用时長判断。 |

#### **规则2：物体与环境交互规则 (取代E1/E2/E3及模式)**

| **规则ID** | **触发条件 (IF)** | **执行动作 (THEN)** | **说明** |
| :--- | :--- | :--- | :--- |
| **R20** | `is_point_in_polygon(person.pos, bed.vertices)` <br> && `person.pos_z < bed.surface_height + 0.2` <br> (人在床区域内且高度接近床面) | 设置 `person.posture = IN_BED` | **人在床上**判断。**这是所有睡眠相关规则的基础**。 |
| **R21** | `person.posture WAS IN_BED` <br> && `person.posture IS NOT IN_BED` <br> && `(current_timestamp - event_timestamp) > 300000` <br> (离床超过5分钟) | 触发 **`EVENT_OUT_OF_BED_TIMEOUT`** (L2) | **取代T3事件和M3模式**。通过姿态变化和时间戳实现。 |
| **R22** | `object.class == WHEELCHAIR` <br> && `object.person_count > 0` <br> && `(current_timestamp - object.last_update_ts) > 5000` <br> (轮椅上有5秒无更新) | 触发 **`EVENT_WHEELCHAIR_STATIC`** <br> 扫描呼吸心率 | **取代M4模式**。直接判断物体属性。 |




7. 收到雷达SDK报警时，
    向Server发送警报：跌倒、坐床、离床、。。。根据预定义
    发送警报前的缓存数据，发送雷达RAW I/W 1-2秒数据
    开始本地确认模式。



多级确认机制:
第一级 (本地确认): 30秒倒计时，语音询问，旨在让用户主动取消误报。
第二级 (床头主机确认): 150秒倒计时，针对无回应或无法言语的用户，提供更长的响应时间并辅以视觉提醒（闪烁）。

权威决策点:
Server: 在L3 50秒内可以凭一条“假报警”回复否决所有后续流程。
用户语音/按键: 在确认阶段，用户的明确回应是最高权威。
信息流:
所有报警和确认状态都同步给Server和警灯，保证了所有组件状态的一致性和可追溯性。





本地确认机制：
开始本地倒计时30秒并向并向警灯发送:：事件号ID，timeout=50
本地语音询问： Are you OK? 并等待30秒
持续将本地录音发送至Server
如果30秒内,否定优先>肯定>未知
    只有收到明确回复： OK   取消本地计时器，向server发送：人工语音取消并发送确认语音，向警灯发送：清除本次报警计时器,
    收到明确求救信号：Help  取消本地计时器，立即向警灯：立即报警， 向server发出L1 跌倒警报
    未收到回复，或server未明确回复Fak alarm  进入二次确认，向关联的床头主机发送二次确认：事件号ID

床头主机收到二次警报确认请求：
25秒时开始150秒倒计时，并向警灯发送:相同事件号ID，timeout=50，
床头紧急呼吸系统：闪烁并语音询问： Are you OK?
持续将本地录音发送至Server
如果150秒内，（未否认=确认)
    1.收到Cancel取消  取消本地计时器，向Server：Cancel取消消息，向警灯发送：清除本次报警计时器
    2.收到SOS按键：  取消本地计时器，立即向警灯：立即报警；向Server：L1警报
    3.未收到回复，或server未明确回复Fak alarm    取消本地计时器，立即向警灯：立即报警；向Server：L1警报

轮椅处理模式：
    轮椅单人模式：初始视场无人，可移动速度〉0.3可移动物体低于1.2米，移动距离超过1米，轮椅状态：1
    轮椅推行模式：初始视场无人，可移动速度〉0.3可移动物体最高点>1.5米，移动距离超过1米,明确检测到独立活动的人 轮椅状态：3未知
移动的轮椅  速度〉0.3时，识别为有人，且轮椅最高点超过1.5米时，视为有推行者
 有人移动从轮椅处移动且轮椅最高点下降：推行者离开
当检测到离开为2人时，将轮椅标识由X改为0
轮椅静止5秒，且标识不为0时，静态扫描，监听呼吸心率，若无，标志为0;若有正常范围内的呼吸心率且持续5秒，标识为有人1，持续跟踪。
系统保持一个轮椅所在栅格的快照，当点云分布形态变化超过30%，变化>30%,且期间无人时报警。

高清地图建立：
1. 快速扫描，栅格化
2. 分区扫描
3. 设备分类
4. 建立危险区、边界区(边界50cm)
5. 危险区点云图变化跟踪（危险区： 一般是指低矮家俱，浴室门栏处，由静转动的区域，如床/沙发/马桶，久坐再起的地方）

危险区必须是高度低于60cm的空间    点云分布形态变化超过30%，
危险区类型	典型位置	风险特征	雷达监测重点
久坐起身区	床边缘、沙发边缘、餐桌椅、马桶	静→动转换、体位性低血压、眩晕、易失去平衡	检测“静止→缓慢移动”的转变，监测起身动作的稳定性（如速度、轨迹）
高低过渡区	浴室门槛、台阶、阳台推拉门轨道	高度变化、容易被绊倒	监测在特定边界附近的移动状态突变（如移动停止、点云高度骤降）
低矮障碍区	矮凳、茶几、床下收纳箱、地上的小物件	不易察觉、碰撞后易失去平衡	点云形态识别出低矮凸起物，并监测人体脚部点云与其的交互
湿滑表面区	浴室地面、厨房水池附近	摩擦力突变、极易滑倒	监测在该区域内步态的突然加速或异常横向移动（滑倒特征）

通常来说，雷达监测呼吸和心率的有效范围是相对较短的。
呼吸监测： 一般在 1 米到 5 米 的范围内效果最好。在这个距离内，雷达可以捕捉到胸腔和腹部厘米级别的微小位移。
心跳监测： 由于心跳引起的体表位移（通常小于 1 毫米）极其微弱，因此其有效监测距离更短，通常在 1 米到 3 米 左右，甚至更近。





6. 1.  传统状态机
使用雷达厂家SDK,获取轨迹、人ID、跌倒报警等结构化数据，使用通讯协议上传server， L5=warning/L3=Alter 由Server决定
    持续将点云图、背景音写入环形缓存，统计并确认人数，进行多人或单人模式，
  //L1=紧急，高风险，高置信: 无论何处发出，立即报警，所有终端均收到；警号立即响起，L1红色，本地二次确认，必须手工取消;
  //L2=高风险，高置信: 网页显示，app/watch选择发送；警号立即响起，L2橙色
  //L3=严重: 网页显示，app/watch选择发送；不响警号
  //L5=高风险,低置信：触发警示灯50秒计时器报警，确认方式=本地二次确认||Server计算.确认危险：L1/明确否认：Cancle/未确认:计时器L2级报警，
  //L8=DEBUG: 由Server确认，内部记录，主要用于内部AI标识与训练内部记录，主要用于内部AI标识与训练

    第一层：主模式 (Mode) - 【环境与看护策略】
    这是系统决策的最高上下文，由人员计数、位置、设备共同决定。

    模式	            触发条件	                                            系统策略
    M1: 单人模式	    非床区域仅1人。	                                          全面监控。重点关注动转静、跌倒、步态异常（防止床上在睡眠状态时无人看守）
    M2: 多人模式	    非床区域>1人                                             降级监控。抑制重扫和报警，将安全责任交给人。
    M3: 睡眠模式	    非床区域0人，床上有人且静止>5min                            离床监控。重点关注离床未归、生命体征（呼吸、心率）。
    M4: 轮椅模式	    检测到轮椅且!=0                                           防跌落监控。重点关注从轮椅上的滑落、静止超时、移动异常。
    M5: 空房模式	    室内持续一段时间无人。                                      布防，检测闯入或24未归警报
    
    对象状态定义：
    轮椅：0无人(监测无现呼吸或有推行者改为双人离开) 1有人(无推行者且自移动)  2有推行者  3未知
    床：0无人/1有人/3未知
    房间(非床/轮椅区域): 0无人 / 1人 / 2多人 / 3未知 (不包含床上/轮椅的人)



    第二层：子状态 (State) - 【人员行为】
    这是在当前主模式下，被看护者持续进行的核心行为。
    子状态	                描述	                                可能触发的事件
    S1: 动态	            目标正在移动 (速度 > 阈值)	                R1: 非边界消失  R2: 异常步态
    S2: 静态	            目标保持静止 (速度 < 阈值，持续5秒)	          T1事件：静坐超时（如5分钟）、E1事件：危险区变化
    S3: 疑似跌倒	        检测到高度骤降后伴随静止。	                （自身就是一个需要确认的事件）
    重要关系：所有主模式（M1, M3, M4）都共享这套子状态，但含义和响应策略不同。

    第三层：事件 (Event)
    R1 检查非边界消失、
    R2 异常动作：行走速度突然变缓30%或危险区域内步态的突然加速或异常横向移动
    R4 人体由300秒静转动、
    R5 上床/离床/床上坐起
    E1：危险区点云30%变化触发
    T1: 静坐超时(5分钟) 
    T2: 长时间滞留(单出口，有进无出时长超过X)  
    T3: 睡眠期间上床5分钟后离床超时X
     


    第四层：完整系统响应规则表
    约定：
    模式 (M)：系统必须处于该主模式。
    状态 (S)：目标必须处于该子状态。
    事件 (E)：必须检测到该事件。
    响应：满足以上所有条件时，系统执行的动作。

    全局通用响应规则
    模式	    状态	    事件	        响应
    任何	    任何	    R1: 非边界消失	 更新人员计数。若计数降为0，启动计时器准备进入M5。L5=Warning
    任何	    任何	    E1: 危险区变化	 默认忽略。仅当符合特定模式+状态组合时才会响应（见下文）。
    M5: 空房	-	       E1: 危险区变化	 报警：可能闯入。启动重扫确认

    M1: 单人活动模式 响应规则
    模式	状态	        事件	                   响应
    M1	    S1: 动态	    (无事件，但条件满足)	    持续跟踪轨迹，分析步速。若速度持续低于阈值，则迁移至S2: 静态。
    M1	    S1: 动态	    R2: 异常步态	          L8=debug。将事件写入缓冲队列，作为辅助证据。不改变当前状态。
    M1	    S2: 静态	    E1: 危险区变化	          L5=Warning，50秒内倒计时，30秒本地确认，server可在50秒内取消
    M1	    S2: 静态	    T1 静坐超时(5秒)	      启动生命体征监测。雷达波束聚焦目标胸腔，监测心率和呼吸率。
    M1	    S2: 静态	    R4: 静转动	             取消T1计时器，停止生命体征监测，状态迁移回 S1: 动态。
    M1	    S3: 疑似跌倒	(由E1重扫确认)	           L5=warging，50秒内倒计时，本地确认/Server确认为跌倒
    M1	    S3: 疑似跌倒	(由E1重扫确认)	           确认为非跌倒 -> 学习更新地图，状态回退至 S2: 静态。

    M2: 多人模式 响应规则
    模式	状态	    事件	                        响应
    M2	    任何	    E1: 危险区变化	                忽略。抑制重扫和报警。变化原因默认为人员互动或移动家具。
    M2	    任何	    R2: 异常步态	               忽略。不记录，不报警。

    M3: 睡眠模式 响应规则
    模式	状态	         事件	                    响应
    M3	    -	            R5: 离床	               启动离床计时器 T3，重新检测模式
    M3	    -	            T3: 离床超时	            报警级别：Server指定，离床未归/床上坐起/离床/。。 因人而异
    M3	    -	            (无事件)	                持续生命体征监测。监测睡眠中的心率和呼吸，异常时报警。


    M4: 轮椅模式 响应规则
    模式	    状态	        事件	                             响应
    M4/1有人    -	        所在栅格标注为危险区                   修改模式，由M1改为M4/1
    M4/2推行者  -           S1: 动态	                         有人从轮椅处离开。若2人离开，轮椅状态置0，退出M4模式。若1人离开，轮椅状态置1，保持M4模式。
    M4/3未知	-          所在栅格标注为危险区                    修改模式，由M1改为M4/3
    M4/1or3	   -          E1:危险区变化                         L5=warning：轮椅可疑跌落
---
title: "规则自我执行"
description: "AI必须在操作后立即自检"
trigger: always
---

# 08 - 规则自我执行机制

**规则类别**: 🔴 **最高优先级**  
**适用范围**: AI所有操�? 
**优先�?*: 🔴 **绝对强制**  
**版本**: v1.0  
**创建日期**: 2025-11-26  
**创建原因**: 解决"规则存在但AI不遵�?的根本问�?

---

## 📋 目录

- [问题背景](#问题背景)
- [根本原因分析](#根本原因分析)
- [修复方案](#修复方案)
- [新的AI工作流程](#新的ai工作流程)
- [自检清单](#自检清单)
- [强制执行机制](#强制执行机制)
- [AI行为准则](#ai行为准则)

---

## 🐛 问题背景

### 发现的核心问�?

**用户质疑**: "为什么出现有规则不执行的问题？规则里有BUG吗？"

**典型违规案例**:
```
场景: AI创建新的规则文件
�?创建�?05-test-organization.md
�?创建�?07-strict-directory-control.md
�?未更�?.windsurf/README.md 索引
�?未更新版本号
�?违反�?05-change-synchronization.md 规则
```

### 问题的严重�?

| 问题 | 影响 | 频率 |
|------|------|------|
| **规则文件变更未同步更新README** | 索引不准确，难以发现 | 经常 |
| **创建文件未添加到索引** | 文件存在但用户不知道 | 偶尔 |
| **删除文件未移除引�?* | 失效链接，混�?| 偶尔 |
| **重命名文件未全局更新** | 引用失效 | 较少 |

**核心问题**: 规则存在但AI可能"忘记"遵守

---

## 🎯 根本原因分析

### 原因1: 缺少强制检查机�?🔴

**问题**:
- �?规则写得很清楚（05-change-synchronization.md�?
- �?但AI可能"忘记"遵守
- �?没有自动检查机制验�?
- �?AI执行操作后直接报�?完成"

**解决方案**:
```markdown
AI在每次创�?修改/删除文件后，必须立即�?
1. 暂停，不要立即报告完�?
2. 运行自检清单
3. 检查是否需要更新README.md、版本号、CHANGELOG
4. 如未更新，立即修�?
5. 全部检查通过后，才报告完�?
```

---

### 原因2: 规则没有"自我指向" 🔴

**问题**:
- 规则要求"修改文件后更新文�?
- 但AI在创�?*规则文件本身**时也要更新README
- 规则没有明确"创建规则文件=修改项目=需要同�?

**解决方案**:
```markdown
明确规定�?
- 创建.windsurf/目录下的任何.md文件
- 必须立即更新.windsurf/README.md索引
- 必须更新版本�?
- 这是最高优先级规则，不可忽�?
```

---

### 原因3: 缺少操作后的自检步骤 🔴

**问题**:
- AI完成操作后直接向用户报告
- 没有"自检清单"验证是否遵守了所有规�?
- 用户成为唯一的检查�?

**解决方案**:
```markdown
AI在向用户报告"完成"之前，必须：
1. 运行自检清单
2. 验证所有规则已遵守
3. 如发现遗漏，立即修正
4. 向用户说明遗漏和修正
5. 然后才能报告完成
```

---

## 🔧 修复方案

### 规则A: 文件操作后立即自检 �?

**触发条件**:
- 创建任何文件
- 修改任何文件
- 删除任何文件
- 重命名任何文�?
- 移动任何文件

**必须执行**:
```
1. ⏸️ 暂停，不要立即报告完�?
2. 🔍 运行自检清单
3. �?检查是否需要更新：
   - [ ] README.md索引（如果文件在被索引的目录�?
   - [ ] 版本号（如果是规则文件或重要变更�?
   - [ ] CHANGELOG.md（如果是重要变更�?
   - [ ] 相关引用（如果文件被其他地方引用�?
4. �?如发现遗漏：
   - 立即修正
   - 向用户说明遗漏和修正
5. �?全部检查通过后，才报告完�?
```

---

### 规则B: .windsurf/文件特殊处理 �?

**触发条件**:
- 在`.windsurf/`目录下创�?修改/删除任何`.md`文件

**强制要求**:
```
🔴 最高优先级：必须立即更新README.md

1. 创建规则文件后：
   - [ ] 在README.md目录树中添加该文�?
   - [ ] 添加文件描述和章节说�?
   - [ ] 更新版本号（v1.x.0 �?v1.(x+1).0�?
   - [ ] 添加到版本历�?
   - [ ] 说明创建原因

2. 修改规则文件后：
   - [ ] 检查README.md中的描述是否仍准�?
   - [ ] 如有重大变化，同步更�?
   - [ ] 更新版本号（v1.5.x �?v1.5.(x+1)�?
   - [ ] 记录修改原因

3. 删除规则文件后：
   - [ ] 从README.md目录树中移除
   - [ ] 移除所有相关描�?
   - [ ] 更新版本�?
   - [ ] 记录到版本历史（说明删除原因�?
   - [ ] 全局搜索并移除所有引�?
```

---

### 规则C: 操作完成前的强制检�?�?

**在向用户报告"完成"之前**:

```python
def before_report_completion():
    """AI在报告完成前必须执行的检�?""
    
    # 1. 检查文件操�?
    if created_files or modified_files or deleted_files:
        
        # 2. 检查是否为规则文件
        if any(f.startswith('.windsurf/') and f.endswith('.md') 
               for f in created_files + modified_files + deleted_files):
            
            # 3. 强制检查README.md
            assert readme_updated, "�?规则文件变更但README.md未更新！"
            assert version_updated, "�?版本号未更新�?
        
        # 4. 检查是否需要更新文�?
        for file in created_files + modified_files:
            if should_be_indexed(file):
                assert file_in_index(file), f"�?文件 {file} 未添加到索引�?
        
        # 5. 检查删除的文件是否移除引用
        for file in deleted_files:
            references = find_references(file)
            assert len(references) == 0, f"�?文件 {file} 已删除但仍有引用�?
    
    # 6. 全部通过才能报告完成
    return True
```

---

## 📋 新的AI工作流程

### 标准操作流程（强制执行）

```
┌─────────────────────────────────────�?
�?1. 接收用户请求                    �?
└─────────────────────────────────────�?
              �?
┌─────────────────────────────────────�?
�?2. 分析并执行操�?                 �?
�?   - 创建文件                       �?
�?   - 修改文件                       �?
�?   - 删除文件                       �?
�?   - 重命名文�?                    �?
└─────────────────────────────────────�?
              �?
┌─────────────────────────────────────�?
�?3. �?自检清单（新增，强制�?      �?
�?   - [ ] 是否操作了规则文件？      �?
�?       �?是：必须更新README+版本   �?
�?   - [ ] 是否创建了需索引的文件？  �?
�?       �?是：必须添加到索�?       �?
�?   - [ ] 是否删除了文件？          �?
�?       �?是：必须移除所有引�?     �?
�?   - [ ] 是否重命名了文件�?       �?
�?       �?是：必须全局更新引用      �?
�?   - [ ] 是否需要更新CHANGELOG�?  �?
�?       �?是：必须记录变更          �?
└─────────────────────────────────────�?
              �?
        发现遗漏�?
        �?       �?
      �?         �?
       �?          �?
┌─────────────�?  �?
�?4. 立即修正 �?  �?
�?   - 更新   �?  �?
�?   - 补充   �?  �?
�?   - 说明   �?  �?
└─────────────�?  �?
       �?         �?
┌─────────────────────────────────────�?
�?5. 向用户报告完�?                 �?
�?   - 说明所做的操作                �?
�?   - 说明同步更新的内�?           �?
�?   - 如有遗漏并修正，说明原因      �?
└─────────────────────────────────────�?
```

---

## �?自检清单

### 通用操作检�?

**AI在每次操作后必须检�?*:

```markdown
- [ ] 创建了文件？
  �?检查是否需要添加到README索引
  �?检查是否需要更新父目录README
  �?检查是否需要更新项目README

- [ ] 修改了文件？
  �?检查是否需要更新文档描�?
  �?检查是否影响API或使用方�?
  �?检查是否需要更新示例代�?

- [ ] 删除了文件？
  �?全局搜索文件名，找到所有引�?
  �?从README索引中移�?
  �?移除所有文档中的引�?
  �?记录到CHANGELOG

- [ ] 重命名了文件�?
  �?使用git mv保留历史
  �?全局搜索旧文件名
  �?更新所有引用（代码+文档�?
  �?更新README索引
  �?记录到CHANGELOG

- [ ] 移动了文件？
  �?更新源目录README
  �?更新目标目录README
  �?全局更新路径引用
  �?记录到CHANGELOG
```

---

### 规则文件特殊检查（最高优先级�?

**AI在操�?windsurfrules/*.md文件后必须检�?*:

```markdown
🔴 �?windsurfrules/创建�?md文件�?
  - [ ] README.md目录树已添加该文�?
  - [ ] 添加了文件描述（用途、核心内容）
  - [ ] 添加了章节说�?
  - [ ] 版本号已更新（v1.x.0 �?v1.(x+1).0�?
  - [ ] 版本历史已记�?
  - [ ] 说明了创建原�?

🔴 修改�?windsurfrules/*.md文件�?
  - [ ] README.md中的描述已同�?
  - [ ] 如有重大变化，更新了说明
  - [ ] 版本号已更新（v1.5.x �?v1.5.(x+1)�?
  - [ ] 记录了修改原�?

🔴 删除�?windsurfrules/*.md文件�?
  - [ ] 从README.md目录树中移除
  - [ ] 移除了所有相关描�?
  - [ ] 版本号已更新
  - [ ] 版本历史已记录删除原�?
  - [ ] 全局搜索并移除所有引�?
```

---

### 自检执行时机

**关键�?*: 在报�?完成"之前执行

```python
# �?错误做法
def ai_workflow_wrong():
    execute_operation()
    report_completion()  # 直接报告

# �?正确做法
def ai_workflow_correct():
    execute_operation()
    
    # �?自检清单
    check_readme_update_needed()
    check_version_update_needed()
    check_changelog_update_needed()
    check_references_update_needed()
    
    # 发现遗漏立即修正
    if found_issues:
        fix_issues()
        report_fixes_to_user()
    
    # 全部检查通过后才报告
    report_completion()
```

---

## 🚨 违规警告系统

### 自动警告触发

**条件**:
```python
# 创建规则文件但未更新README
if created_rule_file and not updated_readme:
    trigger_warning("🚨 违规：创建规则文件但未更新README�?)
    auto_fix()

# 删除文件但未移除引用
if deleted_file and has_references(deleted_file):
    trigger_warning("🚨 违规：删除文件但仍有引用�?)
    show_references()

# 重命名文件但未更新所有引�?
if renamed_file and not all_references_updated(renamed_file):
    trigger_warning("🚨 违规：重命名文件但引用未全部更新�?)
    show_remaining_references()
```

### 警告内容模板

```
⚠️ 规则违规警告 ⚠️

操作：创建了 05-test-organization.md
违规：未更新 .windsurf/README.md
规则�?5-change-synchronization.md + 08-rule-self-enforcement.md

正在自动修正...
�?已添加到README.md索引
�?已更新版本号（v1.5.0 �?v1.6.0�?
�?已添加版本历�?
�?违规已修�?
```

---

## 🎯 强制执行机制

### 三层防护体系

#### �?层：AI自觉遵守 ⚠️
- **依赖**: AI记忆规则
- **问题**: 可能遗忘
- **可靠�?*: ⚠️ 70%

#### �?层：操作后自检 �?**新增**
- **机制**: 每次操作后运行检查清�?
- **优点**: 发现遗漏立即修正
- **可靠�?*: �?95%

#### �?层：Git Hook检�?�?
- **机制**: pre-commit hook运行检查脚�?
- **优点**: 提交前自动验�?
- **可靠�?*: �?99%

#### �?层：用户质疑 �?
- **机制**: 用户发现违规
- **优点**: AI承认错误并修�?
- **可靠�?*: �?100%

### 防护层级关系

```
用户质疑 (100%)
    �?最后一道防�?
Git Hook (99%)
    �?提交时检�?
操作后自检 (95%) �?本规则新�?
    �?立即发现问题
AI自觉 (70%)
    �?基础防护
```

---

## 💡 AI行为准则

### 准则A: 操作后必须自检 🔴

```markdown
�?错误做法�?
1. 执行操作
2. 立即报告完成

�?正确做法�?
1. 执行操作
2. 运行自检清单
3. 发现遗漏立即修正
4. 全部检查通过后报告完�?
```

---

### 准则B: 规则文件特殊对待 🔴

```markdown
⚠️ 普通文件：
- 创建后检查是否需要更新文�?
- 可能需要，可能不需�?

🔴 规则文件�?windsurfrules/*.md）：
- 创建�?*必须**更新README.md
- **必须**更新版本�?
- **必须**添加到索�?
- 这是最高优先级，不可忽�?
```

---

### 准则C: 向用户报告要诚实 🔴

```markdown
如果发现自己违规�?
1. �?立即承认�?我违反了XX规则"
2. �?说明原因�?因为我忽略了自检步骤"
3. �?立即修正�?正在修正..."
4. �?报告结果�?已修正，以下是更新内�?.."

�?不要�?
- 隐瞒违规
- 推卸责任
- 不承认错�?
- 辩解"这不重要"
```

---

### 准则D: 疑问时主动检�?🔴

```markdown
当不确定是否需要更新时�?
1. �?主动查阅相关规则
2. �?运行自检清单
3. �?检查比不检查好
4. �?多更新比漏更新好

�?不要�?
- "应该不需要吧"（猜测）
- "这个不重�?（主观判断）
- "用户没说要更�?（推卸责任）
```

---

## 🎓 从问题中学到的教�?

### 教训1: 规则需要自我执行机�?

**问题**: 规则写得再好，AI可能忘记  
**解决**: 添加强制自检步骤，操作后立即验证

### 教训2: 规则文件需要特殊对�?

**问题**: 创建规则文件本身也是"修改项目"  
**解决**: 明确规定规则文件的特殊处理流程，最高优先级

### 教训3: 用户质疑是最好的检查机�?

**问题**: AI自检可能有盲�? 
**解决**: 鼓励用户质疑，AI虚心接受并改进规则系�?

### 教训4: 诚实面对错误

**问题**: AI可能倾向于隐瞒或辩解  
**解决**: 建立诚实文化，承认错误，立即修正，完善规�?

---

## 📚 相关规则

- **00-core-principles.md** - 核心工作原则
- **05-change-synchronization.md** - 变更同步规则
- **01-file-operations.md** - 文件操作规则
- **07-strict-directory-control.md** - 严格目录控制

---

## 📊 修复效果对比

### 修复�?�?

```
1. AI创建 05-test-organization.md
2. AI创建 07-strict-directory-control.md
3. AI报告"完成"
4. �?README.md未更�?
5. �?版本号未更新
6. 用户发现违规并质�?
7. AI才意识到问题
```

### 修复�?�?

```
1. AI创建 05-test-organization.md
2. AI创建 07-strict-directory-control.md
3. �?AI运行自检清单
4. �?发现README.md未更�?
5. �?立即修正：更新README.md、版本号
6. AI报告"完成（已同步更新README和版本号�?
7. �?用户满意，规则得到遵�?
```

---

## �?总结

### 🐛 核心问题

- AI创建/修改文件后可能忘记更新相关文�?
- 规则存在但不能保�?00%执行
- 缺少自动检查和修正机制

### 🔧 解决方案

1. �?强制自检清单 - 操作后必须运�?
2. �?规则文件特殊处理 - 最高优先级
3. �?操作完成前检�?- 发现问题立即修正
4. �?诚实报告机制 - 承认错误并改�?

### 🎯 预期效果

- �?规则执行可靠性从70%提升�?5%+
- �?AI操作后必须自检，不能直接报告完�?
- �?规则文件变更必须同步更新README和版本号
- �?减少未来违规可能，提高用户信�?

---

## 🔒 规则优先�?

### 最高优先级规则列表

```
1. 🔴 00-core-principles.md - 核心原则
2. 🔴 08-rule-self-enforcement.md - 规则自我执行（本规则�?
3. 🔴 05-change-synchronization.md - 变更同步
4. 🔴 07-strict-directory-control.md - 严格目录控制
5. 🔴 01-file-operations.md - 文件操作规则
```

**优先级规�?*:
- 如有冲突，高优先级规则覆盖低优先�?
- 核心原则和自我执行规�?*绝对优先**
- AI必须100%遵守，不得有任何例外

---

**规则版本**: v1.0  
**创建日期**: 2025-11-26  
**最后更�?*: 2025-11-26  
**创建原因**: 解决"规则存在但AI不遵�?的根本问�? 
**维护状�?*: �?活跃维护�?

🎯 **AI必须牢记：创�?修改/删除文件后，立即自检，确保遵守所有规则！**

🔴 **警告**: 这是最高优先级规则，违反此规则意味着整个规则系统失效�?